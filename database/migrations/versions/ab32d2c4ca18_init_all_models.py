"""init_all_models

Revision ID: ab32d2c4ca18
Revises: 
Create Date: 2025-11-18 18:10:54.414826

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql
import pgvector

# revision identifiers, used by Alembic.
revision: str = 'ab32d2c4ca18'
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('model_catalog',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('provider', sa.Text(), nullable=False),
    sa.Column('model_name', sa.Text(), nullable=False),
    sa.Column('modality', sa.Text(), server_default=sa.text("'chat'"), nullable=False),
    sa.Column('supports_parallel', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.Column('default_pricing', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('is_active', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("default_pricing IS NULL OR jsonb_typeof(default_pricing) = 'object'", name=op.f('ck_model_catalog_chk_model_catalog_pricing_obj')),
    sa.CheckConstraint("modality IN ('chat','embedding','stt','image','tts','rerank')", name=op.f('ck_model_catalog_chk_model_catalog_modality')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_model_catalog')),
    sa.UniqueConstraint('provider', 'model_name', name='uq_model_catalog_provider_model'),
    schema='partner'
    )
    op.create_index('idx_model_catalog_active', 'model_catalog', ['is_active'], unique=False, schema='partner')
    op.create_index('idx_model_catalog_provider_modality', 'model_catalog', ['provider', 'modality'], unique=False, schema='partner')
    op.create_table('ai_insights',
    sa.Column('insight_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('category', sa.String(length=64), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('data_points_json', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('generated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('insight_id', name=op.f('pk_ai_insights')),
    schema='supervisor'
    )
    op.create_index('idx_ai_insights_category_time', 'ai_insights', ['category', 'generated_at'], unique=False, schema='supervisor')
    op.create_table('alerts',
    sa.Column('alert_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('category', sa.String(length=64), nullable=False),
    sa.Column('severity', sa.String(length=32), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=32), server_default=sa.text("'open'"), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('resolved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('resolved_by', sa.BigInteger(), nullable=True),
    sa.CheckConstraint("(status = 'resolved' AND resolved_at IS NOT NULL) OR (status IN ('open','acknowledged') AND resolved_at IS NULL)", name=op.f('ck_alerts_chk_alerts_resolved_fields')),
    sa.CheckConstraint("severity IN ('low','medium','high','critical')", name=op.f('ck_alerts_chk_alerts_severity')),
    sa.CheckConstraint("status IN ('open','acknowledged','resolved')", name=op.f('ck_alerts_chk_alerts_status')),
    sa.PrimaryKeyConstraint('alert_id', name=op.f('pk_alerts')),
    schema='supervisor'
    )
    op.create_index('idx_alerts_category_time', 'alerts', ['category', 'created_at'], unique=False, schema='supervisor')
    op.create_index('idx_alerts_severity_time', 'alerts', ['severity', 'created_at'], unique=False, schema='supervisor')
    op.create_index('idx_alerts_status_time', 'alerts', ['status', 'created_at'], unique=False, schema='supervisor')
    op.create_index('idx_alerts_unresolved', 'alerts', ['created_at'], unique=False, schema='supervisor', postgresql_where=sa.text("status <> 'resolved'"))
    op.create_table('cohort_metrics',
    sa.Column('cohort_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('cohort_month', sa.Date(), nullable=False),
    sa.Column('metric_type', sa.String(length=64), nullable=False),
    sa.Column('month_offset', sa.Integer(), nullable=False),
    sa.Column('value', sa.Numeric(precision=18, scale=4), nullable=False),
    sa.PrimaryKeyConstraint('cohort_id', name=op.f('pk_cohort_metrics')),
    sa.UniqueConstraint('cohort_month', 'metric_type', 'month_offset', name='uq_cohort_metrics_key'),
    schema='supervisor'
    )
    op.create_index('idx_cohort_metrics_month', 'cohort_metrics', ['cohort_month'], unique=False, schema='supervisor')
    op.create_index('idx_cohort_metrics_type_offset', 'cohort_metrics', ['metric_type', 'month_offset'], unique=False, schema='supervisor')
    op.create_table('danger_zone_logs',
    sa.Column('action_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('action_type', sa.String(length=64), nullable=False),
    sa.Column('performed_by', sa.BigInteger(), nullable=True),
    sa.Column('performed_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('action_id', name=op.f('pk_danger_zone_logs')),
    schema='supervisor'
    )
    op.create_index('idx_danger_zone_logs_type_time', 'danger_zone_logs', ['action_type', 'performed_at'], unique=False, schema='supervisor')
    op.create_table('email_settings',
    sa.Column('email_setting_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('smtp_host', sa.String(length=255), nullable=False),
    sa.Column('smtp_port', sa.Integer(), nullable=False),
    sa.Column('tls_enabled', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('username', sa.String(length=255), nullable=True),
    sa.Column('password_encrypted', sa.Text(), nullable=True),
    sa.Column('sender_name', sa.String(length=128), nullable=True),
    sa.Column('sender_email', sa.String(length=255), nullable=True),
    sa.Column('reply_to', sa.String(length=255), nullable=True),
    sa.Column('template_config_json', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('last_tested_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('email_setting_id', name=op.f('pk_email_settings')),
    schema='supervisor'
    )
    op.create_index('idx_email_settings_host_port', 'email_settings', ['smtp_host', 'smtp_port'], unique=False, schema='supervisor')
    op.create_table('env_variables',
    sa.Column('env_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('key', sa.String(length=128), nullable=False),
    sa.Column('value', sa.Text(), nullable=True),
    sa.Column('scope', sa.String(length=64), nullable=False),
    sa.Column('encrypted', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_by', sa.BigInteger(), nullable=True),
    sa.PrimaryKeyConstraint('env_id', name=op.f('pk_env_variables')),
    sa.UniqueConstraint('key', name=op.f('uq_env_variables_key')),
    schema='supervisor'
    )
    op.create_index('idx_env_variables_scope', 'env_variables', ['scope'], unique=False, schema='supervisor')
    op.create_table('events',
    sa.Column('event_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('occurred_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('source', sa.String(length=128), nullable=False),
    sa.Column('level', sa.String(length=32), nullable=False),
    sa.Column('message', sa.Text(), nullable=False),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.CheckConstraint("level IN ('debug','info','warning','error','critical')", name=op.f('ck_events_chk_events_level')),
    sa.PrimaryKeyConstraint('event_id', 'occurred_at', name='pk_events'),
    schema='supervisor',
    postgresql_partition_by='RANGE (occurred_at)'
    )
    op.create_table('feature_toggles',
    sa.Column('toggle_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('feature_name', sa.String(length=128), nullable=False),
    sa.Column('is_enabled', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.Column('scope', sa.String(length=64), nullable=True),
    sa.Column('target_id', sa.BigInteger(), nullable=True),
    sa.Column('rollout_pct', sa.Integer(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_by', sa.BigInteger(), nullable=True),
    sa.CheckConstraint('rollout_pct IS NULL OR (rollout_pct BETWEEN 0 AND 100)', name=op.f('ck_feature_toggles_chk_feature_toggles_rollout_pct')),
    sa.PrimaryKeyConstraint('toggle_id', name=op.f('pk_feature_toggles')),
    sa.UniqueConstraint('feature_name', 'scope', 'target_id', name='uq_feature_toggles_key_scope_target'),
    schema='supervisor'
    )
    op.create_index('idx_feature_toggles_enabled', 'feature_toggles', ['is_enabled'], unique=False, schema='supervisor')
    op.create_index('idx_feature_toggles_name', 'feature_toggles', ['feature_name'], unique=False, schema='supervisor')
    op.create_table('forecasts',
    sa.Column('forecast_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('metric_type', sa.String(length=64), nullable=False),
    sa.Column('period', sa.Date(), nullable=False),
    sa.Column('value', sa.Numeric(precision=18, scale=4), nullable=False),
    sa.Column('model_info', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('generated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('confidence_interval_json', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.PrimaryKeyConstraint('forecast_id', name=op.f('pk_forecasts')),
    schema='supervisor'
    )
    op.create_index('idx_forecasts_metric_period', 'forecasts', ['metric_type', 'period'], unique=False, schema='supervisor')
    op.create_table('growth_channels',
    sa.Column('channel_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('channel_name', sa.String(length=64), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('channel_id', name=op.f('pk_growth_channels')),
    sa.UniqueConstraint('channel_name', name='uq_growth_channels_name'),
    schema='supervisor'
    )
    op.create_index('idx_growth_channels_name', 'growth_channels', ['channel_name'], unique=False, schema='supervisor')
    op.create_table('integrations',
    sa.Column('integration_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('type', sa.String(length=64), nullable=False),
    sa.Column('config_json', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('status', sa.String(length=32), server_default=sa.text("'active'"), nullable=False),
    sa.Column('last_tested_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("status IN ('active','inactive')", name=op.f('ck_integrations_chk_integrations_status')),
    sa.PrimaryKeyConstraint('integration_id', name=op.f('pk_integrations')),
    schema='supervisor'
    )
    op.create_index('idx_integrations_status', 'integrations', ['status'], unique=False, schema='supervisor')
    op.create_index('idx_integrations_type', 'integrations', ['type'], unique=False, schema='supervisor')
    op.create_table('llm_providers',
    sa.Column('provider_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('provider_name', sa.String(length=64), nullable=False),
    sa.Column('api_key', sa.Text(), nullable=False),
    sa.Column('default_model', sa.String(length=128), nullable=True),
    sa.Column('temperature', sa.String(length=10), nullable=True),
    sa.Column('max_tokens', sa.Integer(), nullable=True),
    sa.Column('last_tested_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.String(length=32), server_default=sa.text("'active'"), nullable=False),
    sa.CheckConstraint("status IN ('active','inactive','deprecated')", name=op.f('ck_llm_providers_chk_llm_providers_status')),
    sa.PrimaryKeyConstraint('provider_id', name=op.f('pk_llm_providers')),
    schema='supervisor'
    )
    op.create_index('idx_llm_providers_name', 'llm_providers', ['provider_name'], unique=False, schema='supervisor')
    op.create_index('idx_llm_providers_status', 'llm_providers', ['status'], unique=False, schema='supervisor')
    op.create_table('logs',
    sa.Column('log_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('service_name', sa.String(length=128), nullable=False),
    sa.Column('level', sa.String(length=32), nullable=False),
    sa.Column('message', sa.Text(), nullable=False),
    sa.Column('context_json', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('logged_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.CheckConstraint("level IN ('debug','info','warning','error','critical')", name=op.f('ck_logs_chk_logs_level')),
    sa.PrimaryKeyConstraint('log_id', 'logged_at', name='pk_logs'),
    schema='supervisor',
    postgresql_partition_by='RANGE (logged_at)'
    )
    op.create_table('plans',
    sa.Column('plan_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('plan_name', sa.String(length=64), nullable=False),
    sa.Column('billing_cycle', sa.String(length=32), server_default=sa.text("'monthly'"), nullable=False),
    sa.Column('price_mrr', sa.Numeric(precision=12, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('price_arr', sa.Numeric(precision=12, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('features_json', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('max_users', sa.Integer(), nullable=True),
    sa.Column('is_active', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('plan_id', name=op.f('pk_plans')),
    sa.UniqueConstraint('plan_name', name='uq_plans_name'),
    schema='supervisor'
    )
    op.create_table('service_status',
    sa.Column('status_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('service_name', sa.String(length=128), nullable=False),
    sa.Column('status', sa.String(length=32), nullable=False),
    sa.Column('message', sa.Text(), nullable=True),
    sa.Column('checked_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('status_id', name=op.f('pk_service_status')),
    schema='supervisor'
    )
    op.create_index('idx_service_status_service_time', 'service_status', ['service_name', 'checked_at'], unique=False, schema='supervisor')
    op.create_index('idx_service_status_status_time', 'service_status', ['status', 'checked_at'], unique=False, schema='supervisor')
    op.create_table('system_metrics',
    sa.Column('metric_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('metric_type', sa.String(length=64), nullable=False),
    sa.Column('resource', sa.String(length=128), nullable=False),
    sa.Column('value', sa.Numeric(precision=18, scale=4), nullable=False),
    sa.Column('unit', sa.String(length=32), nullable=True),
    sa.Column('recorded_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.Column('tags_json', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.PrimaryKeyConstraint('metric_id', 'recorded_at', name='pk_system_metrics'),
    schema='supervisor',
    postgresql_partition_by='RANGE (recorded_at)'
    )
    op.create_table('user_roles',
    sa.Column('role_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('role_name', sa.String(length=64), nullable=False),
    sa.Column('permissions_json', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('role_id', name=op.f('pk_user_roles')),
    sa.UniqueConstraint('role_name', name='uq_user_roles_name'),
    schema='supervisor'
    )
    op.create_table('document_tags',
    sa.Column('tag_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.PrimaryKeyConstraint('tag_id', name=op.f('pk_document_tags')),
    sa.UniqueConstraint('name', name=op.f('uq_document_tags_name')),
    schema='user'
    )
    op.create_index('idx_document_tags_name', 'document_tags', ['name'], unique=False, schema='user')
    op.create_table('project_tags',
    sa.Column('tag_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('color', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('tag_id', name=op.f('pk_project_tags')),
    sa.UniqueConstraint('name', name=op.f('uq_project_tags_name')),
    schema='user'
    )
    op.create_index('idx_project_tags_name', 'project_tags', ['name'], unique=False, schema='user')
    op.create_table('users',
    sa.Column('user_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('email', postgresql.CITEXT(), nullable=False),
    sa.Column('password_hash', sa.Text(), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'active'"), nullable=False),
    sa.Column('default_role', sa.Text(), server_default=sa.text("'member'"), nullable=False),
    sa.Column('last_login_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('user_id', name=op.f('pk_users')),
    sa.UniqueConstraint('email', name=op.f('uq_users_email')),
    schema='user'
    )
    op.create_index('idx_users_status_created', 'users', ['status', 'created_at'], unique=False, schema='user')
    op.create_table('arpu_history',
    sa.Column('record_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('period', sa.Date(), nullable=False),
    sa.Column('arpu_value', sa.Numeric(precision=12, scale=4), nullable=False),
    sa.Column('plan_id', sa.BigInteger(), nullable=True),
    sa.CheckConstraint('arpu_value >= 0', name=op.f('ck_arpu_history_chk_arpu_history_nonneg')),
    sa.ForeignKeyConstraint(['plan_id'], ['supervisor.plans.plan_id'], name=op.f('fk_arpu_history_plan_id_plans'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('record_id', name=op.f('pk_arpu_history')),
    schema='supervisor'
    )
    op.create_index('idx_arpu_history_period', 'arpu_history', ['period'], unique=False, schema='supervisor')
    op.create_index('idx_arpu_history_plan_period', 'arpu_history', ['plan_id', 'period'], unique=False, schema='supervisor')
    op.create_table('organizations',
    sa.Column('organization_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('plan_id', sa.BigInteger(), nullable=True),
    sa.Column('industry', sa.String(length=64), nullable=True),
    sa.Column('company_size', sa.String(length=32), nullable=True),
    sa.Column('status', sa.String(length=32), server_default=sa.text("'active'"), nullable=False),
    sa.Column('joined_at', sa.Date(), server_default=sa.text('CURRENT_DATE'), nullable=False),
    sa.Column('trial_end_at', sa.Date(), nullable=True),
    sa.Column('mrr', sa.Numeric(precision=12, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_by', sa.BigInteger(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("status IN ('active','trial','suspended')", name=op.f('ck_organizations_chk_organizations_status')),
    sa.ForeignKeyConstraint(['plan_id'], ['supervisor.plans.plan_id'], name=op.f('fk_organizations_plan_id_plans'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('organization_id', name=op.f('pk_organizations')),
    schema='supervisor'
    )
    op.create_index('ix_organizations_joined_at', 'organizations', ['joined_at'], unique=False, schema='supervisor')
    op.create_index('ix_organizations_plan_id', 'organizations', ['plan_id'], unique=False, schema='supervisor')
    op.create_index('ix_organizations_status', 'organizations', ['status'], unique=False, schema='supervisor')
    op.create_table('account_deletion_requests',
    sa.Column('request_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'pending'"), nullable=False),
    sa.Column('requested_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('processed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.CheckConstraint('processed_at IS NULL OR processed_at >= requested_at', name=op.f('ck_account_deletion_requests_chk_account_deletion_requests_time')),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_account_deletion_requests_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('request_id', name=op.f('pk_account_deletion_requests')),
    schema='user'
    )
    op.create_index('idx_account_deletion_requests_status_time', 'account_deletion_requests', ['status', 'requested_at'], unique=False, schema='user')
    op.create_index('idx_account_deletion_requests_user', 'account_deletion_requests', ['user_id'], unique=False, schema='user')
    op.create_table('documents',
    sa.Column('knowledge_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('owner_id', sa.BigInteger(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('file_format', sa.Text(), nullable=False),
    sa.Column('file_size_bytes', sa.BigInteger(), nullable=False),
    sa.Column('folder_path', sa.Text(), nullable=True),
    sa.Column('status', sa.Text(), server_default=sa.text("'processing'"), nullable=False),
    sa.Column('chunk_count', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('uploaded_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('chunk_count >= 0', name=op.f('ck_documents_chk_documents_chunk_nonneg')),
    sa.CheckConstraint('file_size_bytes >= 0', name=op.f('ck_documents_chk_documents_size_nonneg')),
    sa.ForeignKeyConstraint(['owner_id'], ['user.users.user_id'], name=op.f('fk_documents_owner_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('knowledge_id', name=op.f('pk_documents')),
    schema='user'
    )
    op.create_index('idx_documents_name_trgm', 'documents', ['name'], unique=False, schema='user', postgresql_using='gin', postgresql_ops={'name': 'gin_trgm_ops'})
    op.create_index('idx_documents_owner_time', 'documents', ['owner_id', 'uploaded_at'], unique=False, schema='user')
    op.create_index('idx_documents_status_time', 'documents', ['status', 'uploaded_at'], unique=False, schema='user')
    op.create_table('model_usage_stats',
    sa.Column('stat_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('model_name', sa.Text(), nullable=False),
    sa.Column('usage_count', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('total_tokens', sa.BigInteger(), server_default=sa.text('0'), nullable=False),
    sa.Column('avg_latency_ms', sa.Integer(), nullable=True),
    sa.Column('satisfaction_score', sa.Numeric(precision=3, scale=2), nullable=True),
    sa.Column('last_used_at', sa.DateTime(timezone=True), nullable=True),
    sa.CheckConstraint('avg_latency_ms IS NULL OR avg_latency_ms >= 0', name=op.f('ck_model_usage_stats_chk_model_usage_stats_latency_nonneg')),
    sa.CheckConstraint('satisfaction_score IS NULL OR (satisfaction_score >= 0 AND satisfaction_score <= 5)', name=op.f('ck_model_usage_stats_chk_model_usage_stats_sat_0_5')),
    sa.CheckConstraint('total_tokens >= 0', name=op.f('ck_model_usage_stats_chk_model_usage_stats_tokens_nonneg')),
    sa.CheckConstraint('usage_count >= 0', name=op.f('ck_model_usage_stats_chk_model_usage_stats_count_nonneg')),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_model_usage_stats_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('stat_id', name=op.f('pk_model_usage_stats')),
    sa.UniqueConstraint('user_id', 'model_name', name='uq_model_usage_stats_user_model'),
    schema='user'
    )
    op.create_index('idx_model_usage_stats_last_used', 'model_usage_stats', ['last_used_at'], unique=False, schema='user')
    op.create_index('idx_model_usage_stats_model', 'model_usage_stats', ['model_name'], unique=False, schema='user')
    op.create_index('idx_model_usage_stats_user', 'model_usage_stats', ['user_id'], unique=False, schema='user')
    op.create_table('notification_events',
    sa.Column('event_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.Column('channel', sa.Text(), nullable=False),
    sa.Column('event_type', sa.Text(), nullable=False),
    sa.Column('status', sa.Text(), nullable=False),
    sa.Column('payload', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('delivered_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_notification_events_user_id_users'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('event_id', name=op.f('pk_notification_events')),
    schema='user'
    )
    op.create_index('idx_notification_events_channel_event_time', 'notification_events', ['channel', 'event_type', 'created_at'], unique=False, schema='user')
    op.create_index('idx_notification_events_status_time', 'notification_events', ['status', 'created_at'], unique=False, schema='user')
    op.create_index('idx_notification_events_user_time', 'notification_events', ['user_id', 'created_at'], unique=False, schema='user')
    op.create_table('practice_sessions',
    sa.Column('session_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('title', sa.Text(), nullable=True),
    sa.Column('started_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.CheckConstraint('completed_at IS NULL OR completed_at >= started_at', name=op.f('ck_practice_sessions_chk_practice_sessions_time')),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_practice_sessions_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('session_id', name=op.f('pk_practice_sessions')),
    schema='user'
    )
    op.create_index('idx_practice_sessions_user_time', 'practice_sessions', ['user_id', 'started_at'], unique=False, schema='user')
    op.create_table('projects',
    sa.Column('project_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('owner_id', sa.BigInteger(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('project_type', sa.Text(), server_default=sa.text("'personal'"), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'active'"), nullable=False),
    sa.Column('progress_percent', sa.Numeric(precision=5, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('practice_hours', sa.Numeric(precision=10, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('conversation_count', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('last_activity_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('conversation_count >= 0', name=op.f('ck_projects_chk_projects_conversation_count_nonneg')),
    sa.CheckConstraint('practice_hours >= 0', name=op.f('ck_projects_chk_projects_practice_hours_nonneg')),
    sa.CheckConstraint('progress_percent >= 0 AND progress_percent <= 100', name=op.f('ck_projects_chk_projects_progress_0_100')),
    sa.ForeignKeyConstraint(['owner_id'], ['user.users.user_id'], name=op.f('fk_projects_owner_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('project_id', name=op.f('pk_projects')),
    schema='user'
    )
    op.create_index('idx_projects_last_activity', 'projects', ['last_activity_at'], unique=False, schema='user')
    op.create_index('idx_projects_owner_status', 'projects', ['owner_id', 'status'], unique=False, schema='user')
    op.create_table('usage_summaries',
    sa.Column('summary_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('period_start', sa.Date(), nullable=False),
    sa.Column('period_end', sa.Date(), nullable=False),
    sa.Column('metric_type', sa.Text(), nullable=False),
    sa.Column('metric_value', sa.Numeric(precision=18, scale=4), nullable=False),
    sa.CheckConstraint('metric_value >= 0', name=op.f('ck_usage_summaries_chk_usage_summaries_value_nonneg')),
    sa.CheckConstraint('period_end >= period_start', name=op.f('ck_usage_summaries_chk_usage_summaries_period_valid')),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_usage_summaries_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('summary_id', name=op.f('pk_usage_summaries')),
    sa.UniqueConstraint('user_id', 'period_start', 'metric_type', name='uq_usage_summaries_user_period_metric'),
    schema='user'
    )
    op.create_index('idx_usage_summaries_user_period', 'usage_summaries', ['user_id', 'period_start'], unique=False, schema='user')
    op.create_table('user_achievements',
    sa.Column('achievement_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('achievement_key', sa.Text(), nullable=False),
    sa.Column('earned_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_user_achievements_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('achievement_id', name=op.f('pk_user_achievements')),
    sa.UniqueConstraint('user_id', 'achievement_key', name='uq_user_achievements_user_key'),
    schema='user'
    )
    op.create_index('idx_user_achievements_user_time', 'user_achievements', ['user_id', 'earned_at'], unique=False, schema='user')
    op.create_table('user_activity_events',
    sa.Column('event_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('event_type', sa.Text(), nullable=False),
    sa.Column('related_type', sa.Text(), nullable=True),
    sa.Column('related_id', sa.BigInteger(), nullable=True),
    sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('occurred_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_user_activity_events_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('event_id', name=op.f('pk_user_activity_events')),
    schema='user'
    )
    op.create_index('idx_user_activity_related', 'user_activity_events', ['related_type', 'related_id'], unique=False, schema='user')
    op.create_index('idx_user_activity_type_time', 'user_activity_events', ['event_type', 'occurred_at'], unique=False, schema='user')
    op.create_index('idx_user_activity_user_time', 'user_activity_events', ['user_id', 'occurred_at'], unique=False, schema='user')
    op.create_table('user_login_sessions',
    sa.Column('session_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('device_name', sa.Text(), nullable=True),
    sa.Column('ip_address', postgresql.INET(), nullable=True),
    sa.Column('location', sa.Text(), nullable=True),
    sa.Column('user_agent', sa.Text(), nullable=True),
    sa.Column('logged_in_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('logged_out_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('is_current', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.CheckConstraint('(logged_out_at IS NULL) OR (logged_out_at >= logged_in_at)', name=op.f('ck_user_login_sessions_chk_user_login_sessions_time')),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_user_login_sessions_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('session_id', name=op.f('pk_user_login_sessions')),
    schema='user'
    )
    op.create_index('idx_user_login_sessions_current', 'user_login_sessions', ['user_id', 'is_current'], unique=False, schema='user')
    op.create_index('idx_user_login_sessions_user_time', 'user_login_sessions', ['user_id', 'logged_in_at'], unique=False, schema='user')
    op.create_table('user_notification_preferences',
    sa.Column('preference_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('channel', sa.Text(), nullable=False),
    sa.Column('event_type', sa.Text(), nullable=False),
    sa.Column('is_enabled', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_user_notification_preferences_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('preference_id', name=op.f('pk_user_notification_preferences')),
    sa.UniqueConstraint('user_id', 'channel', 'event_type', name='uq_user_notif_pref_user_channel_event'),
    schema='user'
    )
    op.create_index('idx_user_notif_pref_channel_event', 'user_notification_preferences', ['channel', 'event_type'], unique=False, schema='user')
    op.create_index('idx_user_notif_pref_user', 'user_notification_preferences', ['user_id'], unique=False, schema='user')
    op.create_table('user_preference_history',
    sa.Column('history_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('preferences', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('changed_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_user_preference_history_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('history_id', name=op.f('pk_user_preference_history')),
    schema='user'
    )
    op.create_index('idx_user_preference_history_user_time', 'user_preference_history', ['user_id', 'changed_at'], unique=False, schema='user')
    op.create_table('user_preferences',
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('preferences', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_user_preferences_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('user_id', name=op.f('pk_user_preferences')),
    schema='user'
    )
    op.create_table('user_privacy_settings',
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('save_conversation_history', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('allow_data_collection', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('allow_personalized_ai', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_user_privacy_settings_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('user_id', name=op.f('pk_user_privacy_settings')),
    schema='user'
    )
    op.create_table('user_profiles',
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('full_name', sa.Text(), nullable=True),
    sa.Column('job_title', sa.Text(), nullable=True),
    sa.Column('department', sa.Text(), nullable=True),
    sa.Column('phone_number', sa.Text(), nullable=True),
    sa.Column('location', sa.Text(), nullable=True),
    sa.Column('bio', sa.Text(), nullable=True),
    sa.Column('avatar_url', sa.Text(), nullable=True),
    sa.Column('avatar_initials', sa.Text(), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_user_profiles_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('user_id', name=op.f('pk_user_profiles')),
    schema='user'
    )
    op.create_table('user_security_settings',
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('two_factor_enabled', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.Column('two_factor_method', sa.Text(), nullable=True),
    sa.Column('backup_codes', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('last_password_change_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('recovery_email', postgresql.CITEXT(), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_user_security_settings_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('user_id', name=op.f('pk_user_security_settings')),
    schema='user'
    )
    op.create_table('invoices',
    sa.Column('invoice_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('organization_id', sa.BigInteger(), nullable=False),
    sa.Column('billing_period_start', sa.Date(), nullable=False),
    sa.Column('billing_period_end', sa.Date(), nullable=False),
    sa.Column('total_amount', sa.Numeric(precision=12, scale=2), nullable=False),
    sa.Column('status', sa.String(length=32), nullable=False),
    sa.Column('issued_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('due_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('paid_at', sa.DateTime(timezone=True), nullable=True),
    sa.CheckConstraint("status IN ('draft','issued','paid','overdue','void')", name=op.f('ck_invoices_chk_invoices_status')),
    sa.CheckConstraint('billing_period_end >= billing_period_start', name=op.f('ck_invoices_chk_invoices_period_valid')),
    sa.CheckConstraint('total_amount >= 0', name=op.f('ck_invoices_chk_invoices_total_nonneg')),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_invoices_organization_id_organizations'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('invoice_id', name=op.f('pk_invoices')),
    sa.UniqueConstraint('organization_id', 'billing_period_start', 'billing_period_end', name='uq_invoices_org_period'),
    schema='supervisor'
    )
    op.create_index('idx_invoices_org_period', 'invoices', ['organization_id', 'billing_period_start'], unique=False, schema='supervisor')
    op.create_index('idx_invoices_status', 'invoices', ['status'], unique=False, schema='supervisor')
    op.create_table('metrics_snapshot',
    sa.Column('snapshot_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('metric_date', sa.Date(), nullable=False),
    sa.Column('metric_type', sa.String(length=64), nullable=False),
    sa.Column('organization_id', sa.BigInteger(), nullable=True),
    sa.Column('value', sa.Numeric(precision=18, scale=4), nullable=False),
    sa.Column('dimension_json', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_metrics_snapshot_organization_id_organizations'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('snapshot_id', name=op.f('pk_metrics_snapshot')),
    schema='supervisor'
    )
    op.create_index('idx_metrics_snapshot_date', 'metrics_snapshot', ['metric_date'], unique=False, schema='supervisor')
    op.create_index('idx_metrics_snapshot_org_date', 'metrics_snapshot', ['organization_id', 'metric_date'], unique=False, schema='supervisor')
    op.create_index('idx_metrics_snapshot_type_date', 'metrics_snapshot', ['metric_type', 'metric_date'], unique=False, schema='supervisor')
    op.create_table('subscription_changes',
    sa.Column('change_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('organization_id', sa.BigInteger(), nullable=False),
    sa.Column('old_plan_id', sa.BigInteger(), nullable=True),
    sa.Column('new_plan_id', sa.BigInteger(), nullable=True),
    sa.Column('effective_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('reason', sa.String(length=255), nullable=True),
    sa.Column('changed_by', sa.BigInteger(), nullable=True),
    sa.ForeignKeyConstraint(['new_plan_id'], ['supervisor.plans.plan_id'], name=op.f('fk_subscription_changes_new_plan_id_plans'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['old_plan_id'], ['supervisor.plans.plan_id'], name=op.f('fk_subscription_changes_old_plan_id_plans'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_subscription_changes_organization_id_organizations'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('change_id', name=op.f('pk_subscription_changes')),
    schema='supervisor'
    )
    op.create_index('idx_subscription_changes_org_time', 'subscription_changes', ['organization_id', 'effective_at'], unique=False, schema='supervisor')
    op.create_table('supervisors',
    sa.Column('user_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('organization_id', sa.BigInteger(), nullable=False),
    sa.Column('email', postgresql.CITEXT(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('role', sa.String(length=64), nullable=False),
    sa.Column('status', sa.String(length=32), server_default=sa.text("'active'"), nullable=False),
    sa.Column('last_active_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('signup_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('session_avg_duration', sa.Integer(), nullable=True),
    sa.Column('total_usage', sa.BigInteger(), server_default=sa.text('0'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_supervisors_organization_id_organizations'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('user_id', name=op.f('pk_supervisors')),
    sa.UniqueConstraint('email', name='uq_supervisors_email'),
    schema='supervisor'
    )
    op.create_index('ix_supervisors_org_id', 'supervisors', ['organization_id'], unique=False, schema='supervisor')
    op.create_index('ix_supervisors_signup_at', 'supervisors', ['signup_at'], unique=False, schema='supervisor')
    op.create_index('ix_supervisors_status', 'supervisors', ['status'], unique=False, schema='supervisor')
    op.create_table('transactions',
    sa.Column('transaction_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('organization_id', sa.BigInteger(), nullable=False),
    sa.Column('plan_id', sa.BigInteger(), nullable=True),
    sa.Column('amount', sa.Numeric(precision=12, scale=2), nullable=False),
    sa.Column('currency', sa.String(length=8), server_default=sa.text("'USD'"), nullable=False),
    sa.Column('status', sa.String(length=32), nullable=False),
    sa.Column('payment_method', sa.String(length=64), nullable=True),
    sa.Column('transaction_type', sa.String(length=32), server_default=sa.text("'subscription'"), nullable=False),
    sa.Column('transacted_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('invoice_url', sa.Text(), nullable=True),
    sa.CheckConstraint("status IN ('pending','succeeded','failed','refunded')", name=op.f('ck_transactions_chk_transactions_status')),
    sa.CheckConstraint("transaction_type IN ('subscription','usage','adjustment')", name=op.f('ck_transactions_chk_transactions_type')),
    sa.CheckConstraint('amount >= 0', name=op.f('ck_transactions_chk_transactions_amount_nonneg')),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_transactions_organization_id_organizations'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['plan_id'], ['supervisor.plans.plan_id'], name=op.f('fk_transactions_plan_id_plans'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('transaction_id', name=op.f('pk_transactions')),
    schema='supervisor'
    )
    op.create_index('idx_transactions_org_time', 'transactions', ['organization_id', 'transacted_at'], unique=False, schema='supervisor')
    op.create_index('idx_transactions_status_time', 'transactions', ['status', 'transacted_at'], unique=False, schema='supervisor')
    op.create_table('usage_features',
    sa.Column('record_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('organization_id', sa.BigInteger(), nullable=False),
    sa.Column('feature_name', sa.String(length=128), nullable=False),
    sa.Column('usage_count', sa.BigInteger(), server_default=sa.text('0'), nullable=False),
    sa.Column('period', sa.Date(), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('usage_count >= 0', name=op.f('ck_usage_features_chk_usage_features_nonneg')),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_usage_features_organization_id_organizations'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('record_id', name=op.f('pk_usage_features')),
    sa.UniqueConstraint('organization_id', 'feature_name', 'period', name='uq_usage_features_org_feature_period'),
    schema='supervisor'
    )
    op.create_index('idx_usage_features_feature_period', 'usage_features', ['feature_name', 'period'], unique=False, schema='supervisor')
    op.create_index('idx_usage_features_org_period', 'usage_features', ['organization_id', 'period'], unique=False, schema='supervisor')
    op.create_table('webhooks',
    sa.Column('webhook_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('organization_id', sa.BigInteger(), nullable=False),
    sa.Column('event_type', sa.String(length=64), nullable=False),
    sa.Column('target_url', sa.Text(), nullable=False),
    sa.Column('status', sa.String(length=32), server_default=sa.text("'active'"), nullable=False),
    sa.Column('secret', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("status IN ('active','disabled')", name=op.f('ck_webhooks_chk_webhooks_status')),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_webhooks_organization_id_organizations'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('webhook_id', name=op.f('pk_webhooks')),
    schema='supervisor'
    )
    op.create_index('idx_webhooks_event', 'webhooks', ['event_type'], unique=False, schema='supervisor')
    op.create_index('idx_webhooks_org', 'webhooks', ['organization_id'], unique=False, schema='supervisor')
    op.create_index('idx_webhooks_status', 'webhooks', ['status'], unique=False, schema='supervisor')
    op.create_table('ai_agents',
    sa.Column('agent_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('owner_id', sa.BigInteger(), nullable=False),
    sa.Column('project_id', sa.BigInteger(), nullable=True),
    sa.Column('knowledge_id', sa.BigInteger(), nullable=True),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('role_description', sa.Text(), nullable=True),
    sa.Column('status', sa.Text(), server_default=sa.text("'draft'"), nullable=False),
    sa.Column('icon', sa.Text(), nullable=True),
    sa.Column('template_source', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['knowledge_id'], ['user.documents.knowledge_id'], name=op.f('fk_ai_agents_knowledge_id_documents'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['owner_id'], ['user.users.user_id'], name=op.f('fk_ai_agents_owner_id_users'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['project_id'], ['user.projects.project_id'], name=op.f('fk_ai_agents_project_id_projects'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('agent_id', name=op.f('pk_ai_agents')),
    schema='user'
    )
    op.create_index('idx_ai_agents_document', 'ai_agents', ['knowledge_id'], unique=False, schema='user')
    op.create_index('idx_ai_agents_owner_status', 'ai_agents', ['owner_id', 'status'], unique=False, schema='user')
    op.create_index('idx_ai_agents_project', 'ai_agents', ['project_id'], unique=False, schema='user')
    op.create_table('document_pages',
    sa.Column('page_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('knowledge_id', sa.BigInteger(), nullable=False),
    sa.Column('page_no', sa.Integer(), nullable=True),
    sa.Column('image_url', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('page_no IS NULL OR page_no >= 1', name=op.f('ck_document_pages_chk_document_pages_page_no_ge_1')),
    sa.ForeignKeyConstraint(['knowledge_id'], ['user.documents.knowledge_id'], name=op.f('fk_document_pages_knowledge_id_documents'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('page_id', name=op.f('pk_document_pages')),
    sa.UniqueConstraint('knowledge_id', 'page_no', name='uq_document_pages_doc_page'),
    schema='user'
    )
    op.create_index('idx_document_pages_doc_page', 'document_pages', ['knowledge_id', 'page_no'], unique=False, schema='user')
    op.create_table('document_processing_jobs',
    sa.Column('job_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('knowledge_id', sa.BigInteger(), nullable=False),
    sa.Column('stage', sa.Text(), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'queued'"), nullable=False),
    sa.Column('message', sa.Text(), nullable=True),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.CheckConstraint('completed_at IS NULL OR started_at IS NULL OR completed_at >= started_at', name=op.f('ck_document_processing_jobs_chk_document_jobs_time')),
    sa.ForeignKeyConstraint(['knowledge_id'], ['user.documents.knowledge_id'], name=op.f('fk_document_processing_jobs_knowledge_id_documents'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('job_id', name=op.f('pk_document_processing_jobs')),
    schema='user'
    )
    op.create_index('idx_document_jobs_doc_time', 'document_processing_jobs', ['knowledge_id', 'started_at'], unique=False, schema='user')
    op.create_index('idx_document_jobs_status', 'document_processing_jobs', ['status'], unique=False, schema='user')
    op.create_table('document_tag_assignments',
    sa.Column('assignment_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('knowledge_id', sa.BigInteger(), nullable=False),
    sa.Column('tag_id', sa.BigInteger(), nullable=False),
    sa.ForeignKeyConstraint(['knowledge_id'], ['user.documents.knowledge_id'], name=op.f('fk_document_tag_assignments_knowledge_id_documents'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['tag_id'], ['user.document_tags.tag_id'], name=op.f('fk_document_tag_assignments_tag_id_document_tags'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('assignment_id', name=op.f('pk_document_tag_assignments')),
    sa.UniqueConstraint('knowledge_id', 'tag_id', name='uq_document_tag_assignments_doc_tag'),
    schema='user'
    )
    op.create_index('idx_document_tag_assignments_doc', 'document_tag_assignments', ['knowledge_id'], unique=False, schema='user')
    op.create_index('idx_document_tag_assignments_tag', 'document_tag_assignments', ['tag_id'], unique=False, schema='user')
    op.create_table('document_usage',
    sa.Column('usage_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('knowledge_id', sa.BigInteger(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.Column('usage_type', sa.Text(), nullable=False),
    sa.Column('usage_count', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('last_used_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('usage_count >= 0', name=op.f('ck_document_usage_chk_document_usage_count_nonneg')),
    sa.ForeignKeyConstraint(['knowledge_id'], ['user.documents.knowledge_id'], name=op.f('fk_document_usage_knowledge_id_documents'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_document_usage_user_id_users'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('usage_id', name=op.f('pk_document_usage')),
    schema='user'
    )
    op.create_index('idx_document_usage_doc_time', 'document_usage', ['knowledge_id', 'last_used_at'], unique=False, schema='user')
    op.create_index('idx_document_usage_user_time', 'document_usage', ['user_id', 'last_used_at'], unique=False, schema='user')
    op.create_table('model_comparisons',
    sa.Column('comparison_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('session_id', sa.BigInteger(), nullable=False),
    sa.Column('model_a', sa.Text(), nullable=False),
    sa.Column('model_b', sa.Text(), nullable=False),
    sa.Column('winner_model', sa.Text(), nullable=True),
    sa.Column('latency_diff_ms', sa.Integer(), nullable=True),
    sa.Column('token_diff', sa.Integer(), nullable=True),
    sa.Column('user_feedback', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('latency_diff_ms IS NULL OR latency_diff_ms >= 0', name=op.f('ck_model_comparisons_chk_model_comparisons_latency_nonneg')),
    sa.CheckConstraint('token_diff IS NULL OR token_diff >= 0', name=op.f('ck_model_comparisons_chk_model_comparisons_token_nonneg')),
    sa.ForeignKeyConstraint(['session_id'], ['user.practice_sessions.session_id'], name=op.f('fk_model_comparisons_session_id_practice_sessions'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('comparison_id', name=op.f('pk_model_comparisons')),
    schema='user'
    )
    op.create_index('idx_model_comparisons_session_time', 'model_comparisons', ['session_id', 'created_at'], unique=False, schema='user')
    op.create_table('practice_session_models',
    sa.Column('session_model_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('session_id', sa.BigInteger(), nullable=False),
    sa.Column('model_name', sa.Text(), nullable=False),
    sa.Column('is_primary', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.ForeignKeyConstraint(['session_id'], ['user.practice_sessions.session_id'], name=op.f('fk_practice_session_models_session_id_practice_sessions'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('session_model_id', name=op.f('pk_practice_session_models')),
    sa.UniqueConstraint('session_id', 'model_name', name='uq_practice_session_models_session_model'),
    schema='user'
    )
    op.create_index('idx_practice_session_models_session', 'practice_session_models', ['session_id'], unique=False, schema='user')
    op.create_index('uq_practice_session_models_primary_once', 'practice_session_models', ['session_id'], unique=True, schema='user', postgresql_where=sa.text('is_primary = true'))
    op.create_table('project_activity',
    sa.Column('activity_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('project_id', sa.BigInteger(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.Column('activity_type', sa.Text(), nullable=False),
    sa.Column('details', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('occurred_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['project_id'], ['user.projects.project_id'], name=op.f('fk_project_activity_project_id_projects'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_project_activity_user_id_users'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('activity_id', name=op.f('pk_project_activity')),
    schema='user'
    )
    op.create_index('idx_project_activity_project_time', 'project_activity', ['project_id', 'occurred_at'], unique=False, schema='user')
    op.create_index('idx_project_activity_type_time', 'project_activity', ['activity_type', 'occurred_at'], unique=False, schema='user')
    op.create_table('project_members',
    sa.Column('project_member_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('project_id', sa.BigInteger(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('role', sa.Text(), server_default=sa.text("'member'"), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'active'"), nullable=False),
    sa.Column('invited_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('joined_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['project_id'], ['user.projects.project_id'], name=op.f('fk_project_members_project_id_projects'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_project_members_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('project_member_id', name=op.f('pk_project_members')),
    sa.UniqueConstraint('project_id', 'user_id', name='uq_project_members_project_user'),
    schema='user'
    )
    op.create_index('idx_project_members_project', 'project_members', ['project_id'], unique=False, schema='user')
    op.create_index('idx_project_members_user', 'project_members', ['user_id'], unique=False, schema='user')
    op.create_table('project_metrics',
    sa.Column('metric_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('project_id', sa.BigInteger(), nullable=False),
    sa.Column('metric_type', sa.Text(), nullable=False),
    sa.Column('metric_value', sa.Numeric(precision=18, scale=4), nullable=False),
    sa.Column('recorded_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['project_id'], ['user.projects.project_id'], name=op.f('fk_project_metrics_project_id_projects'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('metric_id', name=op.f('pk_project_metrics')),
    schema='user'
    )
    op.create_index('idx_project_metrics_project_time', 'project_metrics', ['project_id', 'recorded_at'], unique=False, schema='user')
    op.create_index('idx_project_metrics_type_time', 'project_metrics', ['metric_type', 'recorded_at'], unique=False, schema='user')
    op.create_table('project_tag_assignments',
    sa.Column('assignment_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('project_id', sa.BigInteger(), nullable=False),
    sa.Column('tag_id', sa.BigInteger(), nullable=False),
    sa.ForeignKeyConstraint(['project_id'], ['user.projects.project_id'], name=op.f('fk_project_tag_assignments_project_id_projects'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['tag_id'], ['user.project_tags.tag_id'], name=op.f('fk_project_tag_assignments_tag_id_project_tags'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('assignment_id', name=op.f('pk_project_tag_assignments')),
    sa.UniqueConstraint('project_id', 'tag_id', name='uq_project_tag_assignments_project_tag'),
    schema='user'
    )
    op.create_index('idx_project_tag_assignments_project', 'project_tag_assignments', ['project_id'], unique=False, schema='user')
    op.create_table('partners',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('code', sa.Text(), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'active'"), nullable=False),
    sa.Column('timezone', sa.Text(), server_default=sa.text("'UTC'"), nullable=False),
    sa.Column('created_by', sa.BigInteger(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("status IN ('active','inactive','suspended')", name=op.f('ck_partners_chk_partners_status')),
    sa.ForeignKeyConstraint(['created_by'], ['supervisor.supervisors.user_id'], name=op.f('fk_partners_created_by_supervisors'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_partners')),
    sa.UniqueConstraint('code', name='uq_partners_code'),
    schema='partner'
    )
    op.create_index('idx_partners_created', 'partners', ['created_at'], unique=False, schema='partner')
    op.create_index('idx_partners_created_by', 'partners', ['created_by'], unique=False, schema='partner')
    op.create_index('idx_partners_status', 'partners', ['status'], unique=False, schema='partner')
    op.create_table('api_keys',
    sa.Column('api_key_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('name', sa.String(length=128), nullable=False),
    sa.Column('key_hash', sa.Text(), nullable=False),
    sa.Column('status', sa.String(length=32), server_default=sa.text("'active'"), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('created_by', sa.BigInteger(), nullable=True),
    sa.Column('last_used_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('revoked_at', sa.DateTime(timezone=True), nullable=True),
    sa.CheckConstraint("status IN ('active','revoked','disabled')", name=op.f('ck_api_keys_chk_api_keys_status')),
    sa.ForeignKeyConstraint(['created_by'], ['supervisor.supervisors.user_id'], name=op.f('fk_api_keys_created_by_supervisors'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('api_key_id', name=op.f('pk_api_keys')),
    sa.UniqueConstraint('key_hash', name=op.f('uq_api_keys_key_hash')),
    schema='supervisor'
    )
    op.create_index('idx_api_keys_last_used', 'api_keys', ['last_used_at'], unique=False, schema='supervisor')
    op.create_index('idx_api_keys_status', 'api_keys', ['status'], unique=False, schema='supervisor')
    op.create_table('api_usage',
    sa.Column('usage_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('organization_id', sa.BigInteger(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.Column('provider', sa.String(length=64), nullable=False),
    sa.Column('endpoint', sa.String(length=128), nullable=False),
    sa.Column('tokens', sa.BigInteger(), server_default=sa.text('0'), nullable=False),
    sa.Column('cost', sa.Numeric(precision=12, scale=4), server_default=sa.text('0'), nullable=False),
    sa.Column('status', sa.String(length=32), nullable=False),
    sa.Column('response_time_ms', sa.Integer(), nullable=True),
    sa.Column('requested_at', sa.DateTime(timezone=True), server_default=sa.text('NOW()'), nullable=False),
    sa.CheckConstraint("status IN ('success','error','timeout','rate_limited')", name=op.f('ck_api_usage_chk_api_usage_status')),
    sa.CheckConstraint('cost >= 0', name=op.f('ck_api_usage_chk_api_usage_cost_nonneg')),
    sa.CheckConstraint('response_time_ms IS NULL OR response_time_ms >= 0', name=op.f('ck_api_usage_chk_api_usage_latency_nonneg')),
    sa.CheckConstraint('tokens >= 0', name=op.f('ck_api_usage_chk_api_usage_tokens_nonneg')),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_api_usage_organization_id_organizations'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['supervisor.supervisors.user_id'], name=op.f('fk_api_usage_user_id_supervisors'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('usage_id', 'requested_at', name='pk_api_usage'),
    schema='supervisor',
    postgresql_partition_by='RANGE (requested_at)'
    )
    op.create_table('feedback',
    sa.Column('feedback_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.Column('organization_id', sa.BigInteger(), nullable=True),
    sa.Column('category', sa.String(length=64), nullable=True),
    sa.Column('rating', sa.Integer(), nullable=True),
    sa.Column('comment', sa.Text(), nullable=True),
    sa.Column('submitted_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('rating IS NULL OR (rating BETWEEN 1 AND 5)', name=op.f('ck_feedback_chk_feedback_rating_1_5')),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_feedback_organization_id_organizations'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['supervisor.supervisors.user_id'], name=op.f('fk_feedback_user_id_supervisors'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('feedback_id', name=op.f('pk_feedback')),
    sa.UniqueConstraint('user_id', 'organization_id', 'category', name='uq_feedback_user_org_category_once'),
    schema='supervisor'
    )
    op.create_index('idx_feedback_org_time', 'feedback', ['organization_id', 'submitted_at'], unique=False, schema='supervisor')
    op.create_index('idx_feedback_rating_time', 'feedback', ['rating', 'submitted_at'], unique=False, schema='supervisor')
    op.create_index('idx_feedback_user_time', 'feedback', ['user_id', 'submitted_at'], unique=False, schema='supervisor')
    op.create_table('platform_settings',
    sa.Column('setting_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('category', sa.String(length=64), nullable=False),
    sa.Column('key', sa.String(length=128), nullable=False),
    sa.Column('value', sa.Text(), nullable=True),
    sa.Column('value_type', sa.String(length=32), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_by', sa.BigInteger(), nullable=True),
    sa.ForeignKeyConstraint(['updated_by'], ['supervisor.supervisors.user_id'], name=op.f('fk_platform_settings_updated_by_supervisors'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('setting_id', name=op.f('pk_platform_settings')),
    sa.UniqueConstraint('category', 'key', name='uq_platform_settings_category_key'),
    schema='supervisor'
    )
    op.create_index('idx_platform_settings_category', 'platform_settings', ['category'], unique=False, schema='supervisor')
    op.create_index('idx_platform_settings_key', 'platform_settings', ['key'], unique=False, schema='supervisor')
    op.create_table('rate_limits',
    sa.Column('limit_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('plan_id', sa.BigInteger(), nullable=True),
    sa.Column('organization_id', sa.BigInteger(), nullable=True),
    sa.Column('limit_type', sa.String(length=64), nullable=False),
    sa.Column('limit_value', sa.Integer(), nullable=False),
    sa.Column('window_sec', sa.Integer(), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_by', sa.BigInteger(), nullable=True),
    sa.CheckConstraint('(plan_id IS NOT NULL AND organization_id IS NULL) OR (plan_id IS NULL AND organization_id IS NOT NULL)', name=op.f('ck_rate_limits_chk_rate_limits_scope_xor')),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_rate_limits_organization_id_organizations'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['plan_id'], ['supervisor.plans.plan_id'], name=op.f('fk_rate_limits_plan_id_plans'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['updated_by'], ['supervisor.supervisors.user_id'], name=op.f('fk_rate_limits_updated_by_supervisors'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('limit_id', name=op.f('pk_rate_limits')),
    schema='supervisor'
    )
    op.create_index('idx_rate_limits_type', 'rate_limits', ['limit_type'], unique=False, schema='supervisor')
    op.create_index('uq_rate_limits_org', 'rate_limits', ['organization_id', 'limit_type'], unique=True, schema='supervisor', postgresql_where=sa.text('organization_id IS NOT NULL'))
    op.create_index('uq_rate_limits_plan', 'rate_limits', ['plan_id', 'limit_type'], unique=True, schema='supervisor', postgresql_where=sa.text('plan_id IS NOT NULL AND organization_id IS NULL'))
    op.create_table('reports',
    sa.Column('report_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('name', sa.String(length=128), nullable=False),
    sa.Column('type', sa.String(length=64), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('definition_json', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('created_by', sa.BigInteger(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['created_by'], ['supervisor.supervisors.user_id'], name=op.f('fk_reports_created_by_supervisors'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('report_id', name=op.f('pk_reports')),
    schema='supervisor'
    )
    op.create_index('idx_reports_name', 'reports', ['name'], unique=False, schema='supervisor')
    op.create_index('idx_reports_type', 'reports', ['type'], unique=False, schema='supervisor')
    op.create_table('sessions',
    sa.Column('session_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('organization_id', sa.BigInteger(), nullable=False),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('ended_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('duration_sec', sa.Integer(), nullable=True),
    sa.Column('device_info', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('ip_address', postgresql.INET(), nullable=True),
    sa.CheckConstraint('duration_sec IS NULL OR duration_sec >= 0', name=op.f('ck_sessions_chk_sessions_duration_nonneg')),
    sa.ForeignKeyConstraint(['organization_id'], ['supervisor.organizations.organization_id'], name=op.f('fk_sessions_organization_id_organizations'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['supervisor.supervisors.user_id'], name=op.f('fk_sessions_user_id_supervisors'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('session_id', name=op.f('pk_sessions')),
    schema='supervisor'
    )
    op.create_index('ix_sessions_org_started', 'sessions', ['organization_id', 'started_at'], unique=False, schema='supervisor')
    op.create_index('ix_sessions_user_started', 'sessions', ['user_id', 'started_at'], unique=False, schema='supervisor')
    op.create_table('user_acquisition',
    sa.Column('acquisition_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('channel_id', sa.BigInteger(), nullable=True),
    sa.Column('acquired_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('campaign_info', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.ForeignKeyConstraint(['channel_id'], ['supervisor.growth_channels.channel_id'], name=op.f('fk_user_acquisition_channel_id_growth_channels'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['supervisor.supervisors.user_id'], name=op.f('fk_user_acquisition_user_id_supervisors'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('acquisition_id', name=op.f('pk_user_acquisition')),
    sa.UniqueConstraint('user_id', 'channel_id', name='uq_user_acquisition_user_channel'),
    schema='supervisor'
    )
    op.create_index('idx_user_acquisition_channel_time', 'user_acquisition', ['channel_id', 'acquired_at'], unique=False, schema='supervisor')
    op.create_index('idx_user_acquisition_user_time', 'user_acquisition', ['user_id', 'acquired_at'], unique=False, schema='supervisor')
    op.create_table('user_role_assignments',
    sa.Column('assignment_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('role_id', sa.BigInteger(), nullable=False),
    sa.Column('assigned_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('assigned_by', sa.BigInteger(), nullable=True),
    sa.ForeignKeyConstraint(['role_id'], ['supervisor.user_roles.role_id'], name=op.f('fk_user_role_assignments_role_id_user_roles'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['supervisor.supervisors.user_id'], name=op.f('fk_user_role_assignments_user_id_supervisors'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('assignment_id', name=op.f('pk_user_role_assignments')),
    sa.UniqueConstraint('user_id', 'role_id', name='uq_user_role_once'),
    schema='supervisor'
    )
    op.create_index('ix_user_role_assignments_role', 'user_role_assignments', ['role_id'], unique=False, schema='supervisor')
    op.create_index('ix_user_role_assignments_user', 'user_role_assignments', ['user_id', 'assigned_at'], unique=False, schema='supervisor')
    op.create_table('agent_examples',
    sa.Column('example_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('agent_id', sa.BigInteger(), nullable=False),
    sa.Column('example_type', sa.Text(), server_default=sa.text("'few_shot'"), nullable=False),
    sa.Column('input_text', sa.Text(), nullable=True),
    sa.Column('output_text', sa.Text(), nullable=True),
    sa.Column('position', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('position IS NULL OR position >= 0', name=op.f('ck_agent_examples_chk_agent_examples_position_nonneg')),
    sa.ForeignKeyConstraint(['agent_id'], ['user.ai_agents.agent_id'], name=op.f('fk_agent_examples_agent_id_ai_agents'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('example_id', name=op.f('pk_agent_examples')),
    schema='user'
    )
    op.create_index('idx_agent_examples_agent_pos', 'agent_examples', ['agent_id', 'position'], unique=False, schema='user')
    op.create_table('agent_prompts',
    sa.Column('prompt_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('agent_id', sa.BigInteger(), nullable=False),
    sa.Column('version', sa.Integer(), nullable=False),
    sa.Column('system_prompt', sa.Text(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('is_active', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.ForeignKeyConstraint(['agent_id'], ['user.ai_agents.agent_id'], name=op.f('fk_agent_prompts_agent_id_ai_agents'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('prompt_id', name=op.f('pk_agent_prompts')),
    sa.UniqueConstraint('agent_id', 'version', name='uq_agent_prompts_agent_version'),
    schema='user'
    )
    op.create_index('idx_agent_prompts_agent', 'agent_prompts', ['agent_id'], unique=False, schema='user')
    op.create_index('uq_agent_prompts_active_once', 'agent_prompts', ['agent_id'], unique=True, schema='user', postgresql_where=sa.text('is_active = true'))
    op.create_table('agent_usage_stats',
    sa.Column('usage_stat_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('agent_id', sa.BigInteger(), nullable=False),
    sa.Column('usage_count', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('last_used_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('avg_rating', sa.Numeric(precision=3, scale=2), nullable=True),
    sa.Column('total_tokens', sa.BigInteger(), server_default=sa.text('0'), nullable=False),
    sa.CheckConstraint('avg_rating IS NULL OR (avg_rating >= 0 AND avg_rating <= 5)', name=op.f('ck_agent_usage_stats_chk_agent_usage_stats_rating_range')),
    sa.CheckConstraint('total_tokens >= 0', name=op.f('ck_agent_usage_stats_chk_agent_usage_stats_tokens_nonneg')),
    sa.CheckConstraint('usage_count >= 0', name=op.f('ck_agent_usage_stats_chk_agent_usage_stats_count_nonneg')),
    sa.ForeignKeyConstraint(['agent_id'], ['user.ai_agents.agent_id'], name=op.f('fk_agent_usage_stats_agent_id_ai_agents'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('usage_stat_id', name=op.f('pk_agent_usage_stats')),
    sa.UniqueConstraint('agent_id', name=op.f('uq_agent_usage_stats_agent_id')),
    schema='user'
    )
    op.create_index('idx_agent_usage_stats_last_used', 'agent_usage_stats', ['last_used_at'], unique=False, schema='user')
    op.create_table('document_chunks',
    sa.Column('chunk_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('knowledge_id', sa.BigInteger(), nullable=False),
    sa.Column('page_id', sa.BigInteger(), nullable=True),
    sa.Column('chunk_index', sa.Integer(), nullable=False),
    sa.Column('chunk_text', sa.Text(), nullable=False),
    sa.Column('vector_memory', pgvector.sqlalchemy.vector.VECTOR(dim=1536), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('chunk_index >= 1', name=op.f('ck_document_chunks_chk_document_chunks_index_ge_1')),
    sa.ForeignKeyConstraint(['knowledge_id'], ['user.documents.knowledge_id'], name=op.f('fk_document_chunks_knowledge_id_documents'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['page_id'], ['user.document_pages.page_id'], name=op.f('fk_document_chunks_page_id_document_pages'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('chunk_id', name=op.f('pk_document_chunks')),
    sa.UniqueConstraint('knowledge_id', 'chunk_index', name='uq_document_chunks_doc_idx'),
    schema='user'
    )
    op.create_index('idx_document_chunks_doc_index', 'document_chunks', ['knowledge_id', 'chunk_index'], unique=False, schema='user')
    op.create_index('idx_document_chunks_doc_page', 'document_chunks', ['knowledge_id', 'page_id'], unique=False, schema='user')
    op.create_index('idx_document_chunks_vec_ivfflat', 'document_chunks', ['vector_memory'], unique=False, schema='user', postgresql_using='ivfflat', postgresql_with={'lists': 100}, postgresql_ops={'vector_memory': 'vector_cosine_ops'})
    op.create_table('practice_responses',
    sa.Column('response_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('session_model_id', sa.BigInteger(), nullable=False),
    sa.Column('prompt_text', sa.Text(), nullable=False),
    sa.Column('response_text', sa.Text(), nullable=False),
    sa.Column('token_usage', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('latency_ms', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('latency_ms IS NULL OR latency_ms >= 0', name=op.f('ck_practice_responses_chk_practice_responses_latency_nonneg')),
    sa.ForeignKeyConstraint(['session_model_id'], ['user.practice_session_models.session_model_id'], name=op.f('fk_practice_responses_session_model_id_practice_session_models'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('response_id', name=op.f('pk_practice_responses')),
    schema='user'
    )
    op.create_index('idx_practice_responses_model_time', 'practice_responses', ['session_model_id', 'created_at'], unique=False, schema='user')
    op.create_table('analytics_snapshots',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('snapshot_date', sa.Date(), nullable=False),
    sa.Column('metric_type', sa.Text(), nullable=False),
    sa.Column('metric_value', sa.Numeric(precision=18, scale=4), nullable=False),
    sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.CheckConstraint('metric_value >= 0', name=op.f('ck_analytics_snapshots_chk_analytics_snapshots_value_nonneg')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_analytics_snapshots_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_analytics_snapshots')),
    sa.UniqueConstraint('partner_id', 'snapshot_date', 'metric_type', name='uq_analytics_snapshots_partner_date_type'),
    schema='partner'
    )
    op.create_index('idx_analytics_snapshots_partner_date', 'analytics_snapshots', ['partner_id', 'snapshot_date'], unique=False, schema='partner')
    op.create_index('idx_analytics_snapshots_type_date', 'analytics_snapshots', ['metric_type', 'snapshot_date'], unique=False, schema='partner')
    op.create_table('api_cost_daily',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('usage_date', sa.Date(), nullable=False),
    sa.Column('provider', sa.Text(), nullable=False),
    sa.Column('total_cost', sa.Numeric(precision=14, scale=4), nullable=False),
    sa.CheckConstraint('total_cost >= 0', name=op.f('ck_api_cost_daily_chk_api_cost_daily_cost_nonneg')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_api_cost_daily_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_api_cost_daily')),
    sa.UniqueConstraint('partner_id', 'usage_date', 'provider', name='uq_api_cost_daily_key'),
    schema='partner'
    )
    op.create_index('idx_api_cost_daily_partner_date', 'api_cost_daily', ['partner_id', 'usage_date'], unique=False, schema='partner')
    op.create_index('idx_api_cost_daily_provider_date', 'api_cost_daily', ['provider', 'usage_date'], unique=False, schema='partner')
    op.create_table('business_profiles',
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('business_registration_number', sa.Text(), nullable=True),
    sa.Column('company_name', sa.Text(), nullable=False),
    sa.Column('representative_name', sa.Text(), nullable=False),
    sa.Column('address_line1', sa.Text(), nullable=False),
    sa.Column('address_line2', sa.Text(), nullable=True),
    sa.Column('city', sa.Text(), nullable=True),
    sa.Column('state', sa.Text(), nullable=True),
    sa.Column('postal_code', sa.Text(), nullable=True),
    sa.Column('country', sa.Text(), nullable=False),
    sa.Column('tax_email', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_business_profiles_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('partner_id', name=op.f('pk_business_profiles')),
    schema='partner'
    )
    op.create_index('idx_business_profiles_country', 'business_profiles', ['country'], unique=False, schema='partner')
    op.create_table('courses',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('title', sa.Text(), nullable=False),
    sa.Column('course_key', sa.Text(), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'draft'"), nullable=False),
    sa.Column('start_date', sa.Date(), nullable=True),
    sa.Column('end_date', sa.Date(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("status IN ('draft','active','archived')", name=op.f('ck_courses_chk_courses_status')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_courses_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_courses')),
    sa.UniqueConstraint('partner_id', 'course_key', name='uq_courses_partner_course_key'),
    schema='partner'
    )
    op.create_index('idx_courses_partner_status', 'courses', ['partner_id', 'status'], unique=False, schema='partner')
    op.create_table('fee_rates',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('fee_type', sa.Text(), nullable=False),
    sa.Column('percentage', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('flat_amount', sa.Numeric(precision=14, scale=2), nullable=True),
    sa.Column('effective_from', sa.Date(), nullable=False),
    sa.Column('effective_to', sa.Date(), nullable=True),
    sa.CheckConstraint('(effective_to IS NULL) OR (effective_to >= effective_from)', name=op.f('ck_fee_rates_chk_fee_rates_period_valid')),
    sa.CheckConstraint('(percentage IS NOT NULL) OR (flat_amount IS NOT NULL)', name=op.f('ck_fee_rates_chk_fee_rates_one_of_pct_flat')),
    sa.CheckConstraint('flat_amount IS NULL OR flat_amount >= 0', name=op.f('ck_fee_rates_chk_fee_rates_flat_nonneg')),
    sa.CheckConstraint('percentage IS NULL OR (percentage >= 0 AND percentage <= 100)', name=op.f('ck_fee_rates_chk_fee_rates_pct_range')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_fee_rates_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_fee_rates')),
    sa.UniqueConstraint('partner_id', 'fee_type', 'effective_from', name='uq_fee_rates_key'),
    schema='partner'
    )
    op.create_index('idx_fee_rates_partner_type', 'fee_rates', ['partner_id', 'fee_type'], unique=False, schema='partner')
    op.create_table('invoices',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('invoice_number', sa.Text(), nullable=False),
    sa.Column('billing_period_start', sa.Date(), nullable=False),
    sa.Column('billing_period_end', sa.Date(), nullable=False),
    sa.Column('total_amount', sa.Numeric(precision=14, scale=2), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'draft'"), nullable=False),
    sa.Column('issued_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('due_date', sa.Date(), nullable=True),
    sa.CheckConstraint("status IN ('draft','issued','paid','overdue','void')", name=op.f('ck_invoices_chk_invoices_status')),
    sa.CheckConstraint('(due_date IS NULL) OR (due_date >= billing_period_end)', name=op.f('ck_invoices_chk_invoices_due_after_period')),
    sa.CheckConstraint('billing_period_end >= billing_period_start', name=op.f('ck_invoices_chk_invoices_period_valid')),
    sa.CheckConstraint('total_amount >= 0', name=op.f('ck_invoices_chk_invoices_total_nonneg')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_invoices_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_invoices')),
    sa.UniqueConstraint('partner_id', 'invoice_number', name='uq_invoices_partner_number'),
    schema='partner'
    )
    op.create_index('idx_invoices_partner_period', 'invoices', ['partner_id', 'billing_period_start'], unique=False, schema='partner')
    op.create_index('idx_invoices_status', 'invoices', ['status'], unique=False, schema='partner')
    op.create_table('model_usage_monthly',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('month', sa.Date(), nullable=False),
    sa.Column('provider', sa.Text(), nullable=False),
    sa.Column('model_name', sa.Text(), nullable=False),
    sa.Column('session_count', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('total_tokens', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('total_cost', sa.Numeric(precision=14, scale=4), server_default=sa.text('0'), nullable=False),
    sa.CheckConstraint("date_trunc('month', month::timestamp) = month::timestamp", name=op.f('ck_model_usage_monthly_chk_model_usage_month_first_day')),
    sa.CheckConstraint('session_count >= 0 AND total_tokens >= 0 AND total_cost >= 0', name=op.f('ck_model_usage_monthly_chk_model_usage_monthly_nonneg')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_model_usage_monthly_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_model_usage_monthly')),
    sa.UniqueConstraint('partner_id', 'month', 'provider', 'model_name', name='uq_model_usage_monthly_key'),
    schema='partner'
    )
    op.create_index('idx_model_usage_monthly_partner_month', 'model_usage_monthly', ['partner_id', 'month'], unique=False, schema='partner')
    op.create_index('idx_model_usage_monthly_provider_model', 'model_usage_monthly', ['provider', 'model_name'], unique=False, schema='partner')
    op.create_table('partner_users',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.Column('full_name', sa.Text(), nullable=False),
    sa.Column('email', postgresql.CITEXT(), nullable=False),
    sa.Column('phone', sa.Text(), nullable=True),
    sa.Column('role', sa.Text(), server_default=sa.text("'partner_admin'"), nullable=False),
    sa.Column('is_active', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('last_login_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("role IN ('partner_admin','instructor','assistant')", name=op.f('ck_partner_users_chk_partner_users_role')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_partner_users_partner_id_partners'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_partner_users_user_id_users'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_partner_users')),
    sa.UniqueConstraint('partner_id', 'email', name='uq_partner_users_partner_email'),
    sa.UniqueConstraint('partner_id', 'user_id', name='uq_partner_users_partner_user'),
    schema='partner'
    )
    op.create_index('idx_partner_users_active', 'partner_users', ['is_active'], unique=False, schema='partner')
    op.create_index('idx_partner_users_last_login', 'partner_users', ['last_login_at'], unique=False, schema='partner')
    op.create_index('idx_partner_users_partner_email', 'partner_users', ['partner_id', 'email'], unique=False, schema='partner')
    op.create_index('idx_partner_users_role', 'partner_users', ['role'], unique=False, schema='partner')
    op.create_table('payout_accounts',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('bank_name', sa.Text(), nullable=False),
    sa.Column('account_number_encrypted', sa.Text(), nullable=False),
    sa.Column('account_holder', sa.Text(), nullable=False),
    sa.Column('routing_number', sa.Text(), nullable=True),
    sa.Column('currency', sa.Text(), server_default=sa.text("'KRW'"), nullable=False),
    sa.Column('is_primary', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("currency IN ('KRW','USD','JPY','EUR')", name=op.f('ck_payout_accounts_chk_payout_accounts_currency')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_payout_accounts_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_payout_accounts')),
    schema='partner'
    )
    op.create_index('idx_payout_accounts_partner', 'payout_accounts', ['partner_id'], unique=False, schema='partner')
    op.create_index('uq_payout_accounts_partner_primary', 'payout_accounts', ['partner_id'], unique=True, schema='partner', postgresql_where=sa.text('is_primary = true'))
    op.create_table('payouts',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('payout_number', sa.Text(), nullable=False),
    sa.Column('period_start', sa.Date(), nullable=False),
    sa.Column('period_end', sa.Date(), nullable=False),
    sa.Column('total_amount', sa.Numeric(precision=14, scale=2), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'pending'"), nullable=False),
    sa.Column('initiated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.CheckConstraint("status IN ('pending','processing','paid','failed','canceled')", name=op.f('ck_payouts_chk_payouts_status')),
    sa.CheckConstraint('period_end >= period_start', name=op.f('ck_payouts_chk_payouts_period_valid')),
    sa.CheckConstraint('total_amount >= 0', name=op.f('ck_payouts_chk_payouts_total_nonneg')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_payouts_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_payouts')),
    sa.UniqueConstraint('partner_id', 'payout_number', name='uq_payouts_partner_number'),
    schema='partner'
    )
    op.create_index('idx_payouts_partner_period', 'payouts', ['partner_id', 'period_start'], unique=False, schema='partner')
    op.create_index('idx_payouts_status', 'payouts', ['status'], unique=False, schema='partner')
    op.create_table('provider_credentials',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('provider', sa.Text(), nullable=False),
    sa.Column('credential_label', sa.Text(), nullable=True),
    sa.Column('api_key_encrypted', sa.Text(), nullable=False),
    sa.Column('is_active', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('last_validated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_provider_credentials_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_provider_credentials')),
    sa.UniqueConstraint('partner_id', 'provider', name='uq_provider_credentials_partner_provider'),
    schema='partner'
    )
    op.create_index('idx_provider_credentials_active', 'provider_credentials', ['is_active'], unique=False, schema='partner')
    op.create_index('idx_provider_credentials_partner_provider', 'provider_credentials', ['partner_id', 'provider'], unique=False, schema='partner')
    op.create_index('idx_provider_credentials_validated', 'provider_credentials', ['last_validated_at'], unique=False, schema='partner')
    op.create_table('students',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('full_name', sa.Text(), nullable=False),
    sa.Column('email', postgresql.CITEXT(), nullable=True),
    sa.Column('status', sa.Text(), server_default=sa.text("'active'"), nullable=False),
    sa.Column('joined_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('primary_contact', sa.Text(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.CheckConstraint("status IN ('active','inactive','archived')", name=op.f('ck_students_chk_students_status')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_students_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_students')),
    schema='partner'
    )
    op.create_index('idx_students_partner_email', 'students', ['partner_id', 'email'], unique=False, schema='partner')
    op.create_index('idx_students_partner_status', 'students', ['partner_id', 'status'], unique=False, schema='partner')
    op.create_index('uq_students_partner_email_notnull', 'students', ['partner_id', 'email'], unique=True, schema='partner', postgresql_where=sa.text('email IS NOT NULL'))
    op.create_table('scheduled_reports',
    sa.Column('schedule_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('report_id', sa.BigInteger(), nullable=False),
    sa.Column('frequency', sa.String(length=32), nullable=False),
    sa.Column('recipients', sa.Text(), nullable=False),
    sa.Column('next_run_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.String(length=32), server_default=sa.text("'active'"), nullable=False),
    sa.Column('last_run_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by', sa.BigInteger(), nullable=True),
    sa.CheckConstraint("status IN ('active','paused','disabled')", name=op.f('ck_scheduled_reports_chk_scheduled_reports_status')),
    sa.ForeignKeyConstraint(['created_by'], ['supervisor.supervisors.user_id'], name=op.f('fk_scheduled_reports_created_by_supervisors'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['report_id'], ['supervisor.reports.report_id'], name=op.f('fk_scheduled_reports_report_id_reports'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('schedule_id', name=op.f('pk_scheduled_reports')),
    schema='supervisor'
    )
    op.create_index('idx_scheduled_reports_report', 'scheduled_reports', ['report_id'], unique=False, schema='supervisor')
    op.create_index('idx_scheduled_reports_status_next', 'scheduled_reports', ['status', 'next_run_at'], unique=False, schema='supervisor')
    op.create_table('practice_ratings',
    sa.Column('rating_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('response_id', sa.BigInteger(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('score', sa.Integer(), nullable=False),
    sa.Column('feedback', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('score >= 1 AND score <= 5', name=op.f('ck_practice_ratings_chk_practice_ratings_score_1_5')),
    sa.ForeignKeyConstraint(['response_id'], ['user.practice_responses.response_id'], name=op.f('fk_practice_ratings_response_id_practice_responses'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['user.users.user_id'], name=op.f('fk_practice_ratings_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('rating_id', name=op.f('pk_practice_ratings')),
    sa.UniqueConstraint('response_id', 'user_id', name='uq_practice_ratings_response_user'),
    schema='user'
    )
    op.create_index('idx_practice_ratings_response', 'practice_ratings', ['response_id'], unique=False, schema='user')
    op.create_index('idx_practice_ratings_user', 'practice_ratings', ['user_id'], unique=False, schema='user')
    op.create_table('classes',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('course_id', sa.BigInteger(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('section_code', sa.Text(), nullable=True),
    sa.Column('status', sa.Text(), server_default=sa.text("'planned'"), nullable=False),
    sa.Column('start_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('end_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('capacity', sa.Integer(), nullable=True),
    sa.Column('timezone', sa.Text(), server_default=sa.text("'UTC'"), nullable=False),
    sa.Column('location', sa.Text(), nullable=True),
    sa.Column('online_url', sa.Text(), nullable=True),
    sa.Column('invite_only', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("status IN ('planned','ongoing','ended')", name=op.f('ck_classes_chk_classes_status')),
    sa.ForeignKeyConstraint(['course_id'], ['partner.courses.id'], name=op.f('fk_classes_course_id_courses'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_classes')),
    sa.UniqueConstraint('course_id', 'section_code', name='uq_classes_course_section', postgresql_nulls_not_distinct=True),
    schema='partner'
    )
    op.create_index('idx_classes_course_status', 'classes', ['course_id', 'status'], unique=False, schema='partner')
    op.create_table('comparison_runs',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('student_id', sa.BigInteger(), nullable=True),
    sa.Column('initiated_by', sa.BigInteger(), nullable=True),
    sa.Column('status', sa.Text(), server_default=sa.text("'running'"), nullable=False),
    sa.Column('started_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('config', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.CheckConstraint("status IN ('running','completed','failed','canceled')", name=op.f('ck_comparison_runs_chk_comparison_runs_status')),
    sa.CheckConstraint('(completed_at IS NULL) OR (completed_at >= started_at)', name=op.f('ck_comparison_runs_chk_comparison_runs_time')),
    sa.CheckConstraint('(student_id IS NOT NULL) OR (initiated_by IS NOT NULL)', name=op.f('ck_comparison_runs_chk_comparison_runs_initiator')),
    sa.ForeignKeyConstraint(['initiated_by'], ['partner.partner_users.id'], name=op.f('fk_comparison_runs_initiated_by_partner_users'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['student_id'], ['partner.students.id'], name=op.f('fk_comparison_runs_student_id_students'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_comparison_runs')),
    schema='partner'
    )
    op.create_index('idx_comparison_runs_initiated_by', 'comparison_runs', ['initiated_by'], unique=False, schema='partner')
    op.create_index('idx_comparison_runs_status_time', 'comparison_runs', ['status', 'started_at'], unique=False, schema='partner')
    op.create_index('idx_comparison_runs_student', 'comparison_runs', ['student_id'], unique=False, schema='partner')
    op.create_table('email_subscriptions',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_user_id', sa.BigInteger(), nullable=False),
    sa.Column('subscription_type', sa.Text(), nullable=False),
    sa.Column('is_subscribed', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("subscription_type IN ('weekly_digest','alerts','marketing')", name=op.f('ck_email_subscriptions_chk_email_subscriptions_type')),
    sa.ForeignKeyConstraint(['partner_user_id'], ['partner.partner_users.id'], name=op.f('fk_email_subscriptions_partner_user_id_partner_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_email_subscriptions')),
    sa.UniqueConstraint('partner_user_id', 'subscription_type', name='uq_email_subscriptions_user_type'),
    schema='partner'
    )
    op.create_index('idx_email_subscriptions_type', 'email_subscriptions', ['subscription_type'], unique=False, schema='partner')
    op.create_index('idx_email_subscriptions_user', 'email_subscriptions', ['partner_user_id'], unique=False, schema='partner')
    op.create_table('login_activity',
    sa.Column('login_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('partner_user_id', sa.BigInteger(), nullable=True),
    sa.Column('ip_address', postgresql.INET(), nullable=True),
    sa.Column('user_agent', sa.Text(), nullable=True),
    sa.Column('status', sa.Text(), server_default=sa.text("'success'"), nullable=False),
    sa.CheckConstraint("status IN ('success','failed')", name=op.f('ck_login_activity_chk_login_activity_status')),
    sa.ForeignKeyConstraint(['partner_user_id'], ['partner.partner_users.id'], name=op.f('fk_login_activity_partner_user_id_partner_users'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('login_at', 'id', name=op.f('pk_login_activity')),
    schema='partner',
    postgresql_partition_by='RANGE (login_at)'
    )
    op.create_index('idx_login_activity_user_time', 'login_activity', ['partner_user_id', 'login_at'], unique=False, schema='partner')
    op.create_table('mfa_settings',
    sa.Column('partner_user_id', sa.BigInteger(), nullable=False),
    sa.Column('is_enabled', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.Column('method', sa.Text(), nullable=True),
    sa.Column('secret_encrypted', sa.Text(), nullable=True),
    sa.Column('last_enabled_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("method IS NULL OR method IN ('totp','sms','email')", name=op.f('ck_mfa_settings_chk_mfa_settings_method')),
    sa.ForeignKeyConstraint(['partner_user_id'], ['partner.partner_users.id'], name=op.f('fk_mfa_settings_partner_user_id_partner_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('partner_user_id', name=op.f('pk_mfa_settings')),
    schema='partner'
    )
    op.create_table('notification_preferences',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_user_id', sa.BigInteger(), nullable=False),
    sa.Column('new_student_email', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('class_deadline_email', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('settlement_email', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('api_cost_alert_email', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('system_notice', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('marketing_opt_in', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['partner_user_id'], ['partner.partner_users.id'], name=op.f('fk_notification_preferences_partner_user_id_partner_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_notification_preferences')),
    sa.UniqueConstraint('partner_user_id', name='uq_notification_preferences_user'),
    schema='partner'
    )
    op.create_index('idx_notification_preferences_user', 'notification_preferences', ['partner_user_id'], unique=False, schema='partner')
    op.create_table('org_llm_settings',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('default_chat_model', sa.Text(), nullable=False),
    sa.Column('enable_parallel_mode', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.Column('daily_message_limit', sa.Integer(), nullable=True),
    sa.Column('token_alert_threshold', sa.Integer(), nullable=True),
    sa.Column('provider_credential_id', sa.BigInteger(), nullable=True),
    sa.Column('updated_by', sa.BigInteger(), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('daily_message_limit IS NULL OR daily_message_limit >= 0', name=op.f('ck_org_llm_settings_chk_org_llm_daily_limit_nonneg')),
    sa.CheckConstraint('token_alert_threshold IS NULL OR token_alert_threshold >= 0', name=op.f('ck_org_llm_settings_chk_org_llm_token_threshold_nonneg')),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_org_llm_settings_partner_id_partners'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['provider_credential_id'], ['partner.provider_credentials.id'], name=op.f('fk_org_llm_settings_provider_credential_id_provider_credentials'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['updated_by'], ['partner.partner_users.id'], name=op.f('fk_org_llm_settings_updated_by_partner_users'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_org_llm_settings')),
    sa.UniqueConstraint('partner_id', name='uq_org_llm_settings_partner'),
    schema='partner'
    )
    op.create_index('idx_org_llm_settings_cred', 'org_llm_settings', ['provider_credential_id'], unique=False, schema='partner')
    op.create_index('idx_org_llm_settings_partner', 'org_llm_settings', ['partner_id'], unique=False, schema='partner')
    op.create_table('payout_items',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('payout_id', sa.BigInteger(), nullable=False),
    sa.Column('invoice_id', sa.BigInteger(), nullable=True),
    sa.Column('amount', sa.Numeric(precision=14, scale=2), nullable=False),
    sa.Column('fee_amount', sa.Numeric(precision=14, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('net_amount', sa.Numeric(precision=14, scale=2), nullable=False),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.CheckConstraint('amount >= 0', name=op.f('ck_payout_items_chk_payout_items_amount_nonneg')),
    sa.CheckConstraint('fee_amount >= 0', name=op.f('ck_payout_items_chk_payout_items_fee_nonneg')),
    sa.CheckConstraint('net_amount = amount - fee_amount', name=op.f('ck_payout_items_chk_payout_items_net_eq')),
    sa.CheckConstraint('net_amount >= 0', name=op.f('ck_payout_items_chk_payout_items_net_nonneg')),
    sa.ForeignKeyConstraint(['invoice_id'], ['partner.invoices.id'], name=op.f('fk_payout_items_invoice_id_invoices'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['payout_id'], ['partner.payouts.id'], name=op.f('fk_payout_items_payout_id_payouts'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_payout_items')),
    schema='partner'
    )
    op.create_index('idx_payout_items_invoice', 'payout_items', ['invoice_id'], unique=False, schema='partner')
    op.create_index('idx_payout_items_payout', 'payout_items', ['payout_id'], unique=False, schema='partner')
    op.create_table('prompt_templates',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=True),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('scope', sa.Text(), server_default=sa.text("'partner'"), nullable=False),
    sa.Column('created_by', sa.BigInteger(), nullable=True),
    sa.Column('is_archived', sa.Boolean(), server_default=sa.text('false'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("(scope = 'global' AND partner_id IS NULL) OR (scope = 'partner' AND partner_id IS NOT NULL)", name=op.f('ck_prompt_templates_chk_prompt_templates_scope_partner_rule')),
    sa.CheckConstraint("scope IN ('partner','global')", name=op.f('ck_prompt_templates_chk_prompt_templates_scope')),
    sa.ForeignKeyConstraint(['created_by'], ['partner.partner_users.id'], name=op.f('fk_prompt_templates_created_by_partner_users'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_prompt_templates_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_prompt_templates')),
    sa.UniqueConstraint('partner_id', 'name', name='uq_prompt_templates_partner_name'),
    schema='partner'
    )
    op.create_index('idx_prompt_templates_is_archived', 'prompt_templates', ['is_archived'], unique=False, schema='partner')
    op.create_index('idx_prompt_templates_partner_name', 'prompt_templates', ['partner_id', 'name'], unique=False, schema='partner')
    op.create_table('report_runs',
    sa.Column('run_id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('report_id', sa.BigInteger(), nullable=False),
    sa.Column('schedule_id', sa.BigInteger(), nullable=True),
    sa.Column('run_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('status', sa.String(length=32), nullable=False),
    sa.Column('generated_file_url', sa.Text(), nullable=True),
    sa.Column('summary', sa.Text(), nullable=True),
    sa.CheckConstraint("status IN ('queued','running','success','failed')", name=op.f('ck_report_runs_chk_report_runs_status')),
    sa.ForeignKeyConstraint(['report_id'], ['supervisor.reports.report_id'], name=op.f('fk_report_runs_report_id_reports'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['schedule_id'], ['supervisor.scheduled_reports.schedule_id'], name=op.f('fk_report_runs_schedule_id_scheduled_reports'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('run_id', name=op.f('pk_report_runs')),
    schema='supervisor'
    )
    op.create_index('idx_report_runs_report_time', 'report_runs', ['report_id', 'run_at'], unique=False, schema='supervisor')
    op.create_index('idx_report_runs_schedule', 'report_runs', ['schedule_id'], unique=False, schema='supervisor')
    op.create_index('idx_report_runs_status_time', 'report_runs', ['status', 'run_at'], unique=False, schema='supervisor')
    op.create_table('ai_sessions',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('student_id', sa.BigInteger(), nullable=True),
    sa.Column('class_id', sa.BigInteger(), nullable=True),
    sa.Column('mode', sa.Text(), nullable=False),
    sa.Column('model_name', sa.Text(), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'active'"), nullable=False),
    sa.Column('started_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('ended_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('total_messages', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('total_tokens', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('total_cost', sa.Numeric(precision=14, scale=4), server_default=sa.text('0'), nullable=False),
    sa.Column('initiated_by', sa.BigInteger(), nullable=True),
    sa.CheckConstraint("mode IN ('single','parallel')", name=op.f('ck_ai_sessions_chk_ai_sessions_mode')),
    sa.CheckConstraint("status IN ('active','completed','canceled','error')", name=op.f('ck_ai_sessions_chk_ai_sessions_status')),
    sa.CheckConstraint('(ended_at IS NULL) OR (ended_at >= started_at)', name=op.f('ck_ai_sessions_chk_ai_sessions_time')),
    sa.CheckConstraint('total_cost     >= 0', name=op.f('ck_ai_sessions_chk_ai_sessions_cost_nonneg')),
    sa.CheckConstraint('total_messages >= 0', name=op.f('ck_ai_sessions_chk_ai_sessions_msgs_nonneg')),
    sa.CheckConstraint('total_tokens   >= 0', name=op.f('ck_ai_sessions_chk_ai_sessions_tokens_nonneg')),
    sa.ForeignKeyConstraint(['class_id'], ['partner.classes.id'], name=op.f('fk_ai_sessions_class_id_classes'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['initiated_by'], ['partner.partner_users.id'], name=op.f('fk_ai_sessions_initiated_by_partner_users'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['student_id'], ['partner.students.id'], name=op.f('fk_ai_sessions_student_id_students'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_sessions')),
    schema='partner'
    )
    op.create_index('idx_ai_sessions_class', 'ai_sessions', ['class_id'], unique=False, schema='partner')
    op.create_index('idx_ai_sessions_mode', 'ai_sessions', ['mode'], unique=False, schema='partner')
    op.create_index('idx_ai_sessions_started', 'ai_sessions', ['started_at'], unique=False, schema='partner')
    op.create_index('idx_ai_sessions_status', 'ai_sessions', ['status'], unique=False, schema='partner')
    op.create_index('idx_ai_sessions_student', 'ai_sessions', ['student_id'], unique=False, schema='partner')
    op.create_table('class_finance_monthly',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('class_id', sa.BigInteger(), nullable=False),
    sa.Column('month', sa.Date(), nullable=False),
    sa.Column('contract_amount', sa.Numeric(precision=14, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('api_cost', sa.Numeric(precision=14, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('platform_fee', sa.Numeric(precision=14, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('payout_amount', sa.Numeric(precision=14, scale=2), server_default=sa.text('0'), nullable=False),
    sa.CheckConstraint("date_trunc('month', month::timestamp) = month::timestamp", name=op.f('ck_class_finance_monthly_chk_cfm_month_is_first_day')),
    sa.CheckConstraint('contract_amount >= 0 AND api_cost >= 0 AND platform_fee >= 0 AND payout_amount >= 0', name=op.f('ck_class_finance_monthly_chk_cfm_amounts_nonneg')),
    sa.ForeignKeyConstraint(['class_id'], ['partner.classes.id'], name=op.f('fk_class_finance_monthly_class_id_classes'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_class_finance_monthly')),
    sa.UniqueConstraint('class_id', 'month', name='uq_class_finance_month'),
    schema='partner'
    )
    op.create_index('idx_class_finance_class_month', 'class_finance_monthly', ['class_id', 'month'], unique=False, schema='partner')
    op.create_table('class_instructors',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('class_id', sa.BigInteger(), nullable=False),
    sa.Column('partner_user_id', sa.BigInteger(), nullable=False),
    sa.Column('role', sa.Text(), server_default=sa.text("'assistant'"), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("role IN ('lead','assistant')", name=op.f('ck_class_instructors_chk_class_instructors_role')),
    sa.ForeignKeyConstraint(['class_id'], ['partner.classes.id'], name=op.f('fk_class_instructors_class_id_classes'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['partner_user_id'], ['partner.partner_users.id'], name=op.f('fk_class_instructors_partner_user_id_partner_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_class_instructors')),
    sa.UniqueConstraint('class_id', 'partner_user_id', name='uq_class_instructors_unique'),
    schema='partner'
    )
    op.create_index('idx_class_instructors_class', 'class_instructors', ['class_id'], unique=False, schema='partner')
    op.create_index('idx_class_instructors_partner_user', 'class_instructors', ['partner_user_id'], unique=False, schema='partner')
    op.create_table('invite_codes',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('class_id', sa.BigInteger(), nullable=True),
    sa.Column('code', sa.Text(), nullable=False),
    sa.Column('target_role', sa.Text(), server_default=sa.text("'student'"), nullable=False),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('max_uses', sa.Integer(), nullable=True),
    sa.Column('used_count', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('status', sa.Text(), server_default=sa.text("'active'"), nullable=False),
    sa.Column('created_by', sa.BigInteger(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("status IN ('active','expired','disabled')", name=op.f('ck_invite_codes_chk_invite_codes_status')),
    sa.CheckConstraint("target_role IN ('instructor','student')", name=op.f('ck_invite_codes_chk_invite_codes_target_role')),
    sa.CheckConstraint('(max_uses IS NULL) OR (used_count <= max_uses)', name=op.f('ck_invite_codes_chk_invite_codes_used_le_max')),
    sa.CheckConstraint('used_count >= 0', name=op.f('ck_invite_codes_chk_invite_codes_used_nonnegative')),
    sa.ForeignKeyConstraint(['class_id'], ['partner.classes.id'], name=op.f('fk_invite_codes_class_id_classes'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['created_by'], ['partner.partner_users.id'], name=op.f('fk_invite_codes_created_by_partner_users'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_invite_codes_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_invite_codes')),
    sa.UniqueConstraint('code', name='uq_invite_codes_code'),
    schema='partner'
    )
    op.create_index('idx_invite_codes_partner_status', 'invite_codes', ['partner_id', 'status'], unique=False, schema='partner')
    op.create_table('prompt_template_versions',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('template_id', sa.BigInteger(), nullable=False),
    sa.Column('version', sa.Integer(), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('created_by', sa.BigInteger(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['created_by'], ['partner.partner_users.id'], name=op.f('fk_prompt_template_versions_created_by_partner_users'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['template_id'], ['partner.prompt_templates.id'], name=op.f('fk_prompt_template_versions_template_id_prompt_templates'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_prompt_template_versions')),
    sa.UniqueConstraint('template_id', 'version', name='uq_prompt_template_versions_template_version'),
    schema='partner'
    )
    op.create_index('idx_prompt_template_versions_template', 'prompt_template_versions', ['template_id'], unique=False, schema='partner')
    op.create_table('comparison_run_items',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('run_id', sa.BigInteger(), nullable=False),
    sa.Column('model_name', sa.Text(), nullable=False),
    sa.Column('prompt_template_version_id', sa.BigInteger(), nullable=True),
    sa.Column('status', sa.Text(), server_default=sa.text("'pending'"), nullable=False),
    sa.Column('total_tokens', sa.Integer(), nullable=True),
    sa.Column('average_latency_ms', sa.Integer(), nullable=True),
    sa.Column('total_cost', sa.Numeric(precision=14, scale=4), nullable=True),
    sa.CheckConstraint("status IN ('pending','running','success','error')", name=op.f('ck_comparison_run_items_chk_comparison_run_items_status')),
    sa.CheckConstraint('average_latency_ms IS NULL OR average_latency_ms >= 0', name=op.f('ck_comparison_run_items_chk_comparison_run_items_latency_nonneg')),
    sa.CheckConstraint('total_cost IS NULL OR total_cost >= 0', name=op.f('ck_comparison_run_items_chk_comparison_run_items_cost_nonneg')),
    sa.CheckConstraint('total_tokens IS NULL OR total_tokens >= 0', name=op.f('ck_comparison_run_items_chk_comparison_run_items_tokens_nonneg')),
    sa.ForeignKeyConstraint(['prompt_template_version_id'], ['partner.prompt_template_versions.id'], name=op.f('fk_comparison_run_items_prompt_template_version_id_prompt_template_versions'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['run_id'], ['partner.comparison_runs.id'], name=op.f('fk_comparison_run_items_run_id_comparison_runs'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_comparison_run_items')),
    sa.UniqueConstraint('run_id', 'model_name', name='uq_comparison_run_items_run_model'),
    schema='partner'
    )
    op.create_index('idx_comparison_run_items_prompt_ver', 'comparison_run_items', ['prompt_template_version_id'], unique=False, schema='partner')
    op.create_index('idx_comparison_run_items_run', 'comparison_run_items', ['run_id'], unique=False, schema='partner')
    op.create_index('idx_comparison_run_items_status', 'comparison_run_items', ['status'], unique=False, schema='partner')
    op.create_table('enrollments',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('class_id', sa.BigInteger(), nullable=False),
    sa.Column('student_id', sa.BigInteger(), nullable=False),
    sa.Column('invite_code_id', sa.BigInteger(), nullable=True),
    sa.Column('status', sa.Text(), server_default=sa.text("'active'"), nullable=False),
    sa.Column('enrolled_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('progress_percent', sa.Numeric(precision=5, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('final_grade', sa.Text(), nullable=True),
    sa.CheckConstraint("status IN ('active','inactive','completed','dropped')", name=op.f('ck_enrollments_chk_enrollments_status')),
    sa.CheckConstraint('(completed_at IS NULL) OR (completed_at >= enrolled_at)', name=op.f('ck_enrollments_chk_enrollments_time')),
    sa.CheckConstraint('progress_percent >= 0 AND progress_percent <= 100', name=op.f('ck_enrollments_chk_enrollments_progress_0_100')),
    sa.ForeignKeyConstraint(['class_id'], ['partner.classes.id'], name=op.f('fk_enrollments_class_id_classes'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['invite_code_id'], ['partner.invite_codes.id'], name=op.f('fk_enrollments_invite_code_id_invite_codes'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['student_id'], ['partner.students.id'], name=op.f('fk_enrollments_student_id_students'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_enrollments')),
    sa.UniqueConstraint('class_id', 'student_id', name='uq_enrollments_class_student'),
    schema='partner'
    )
    op.create_index('idx_enrollments_class', 'enrollments', ['class_id'], unique=False, schema='partner')
    op.create_index('idx_enrollments_status_time', 'enrollments', ['status', 'enrolled_at'], unique=False, schema='partner')
    op.create_index('idx_enrollments_student', 'enrollments', ['student_id'], unique=False, schema='partner')
    op.create_table('prompt_bindings',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('template_version_id', sa.BigInteger(), nullable=False),
    sa.Column('scope_type', sa.Text(), nullable=False),
    sa.Column('scope_id', sa.BigInteger(), nullable=True),
    sa.Column('is_active', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("(scope_type = 'global' AND scope_id IS NULL) OR (scope_type = 'class' AND scope_id IS NOT NULL)", name=op.f('ck_prompt_bindings_chk_prompt_bindings_scope_rule')),
    sa.CheckConstraint("scope_type IN ('class','global')", name=op.f('ck_prompt_bindings_chk_prompt_bindings_scope_type')),
    sa.ForeignKeyConstraint(['template_version_id'], ['partner.prompt_template_versions.id'], name=op.f('fk_prompt_bindings_template_version_id_prompt_template_versions'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_prompt_bindings')),
    sa.UniqueConstraint('scope_type', 'scope_id', 'template_version_id', name='uq_prompt_bindings_scope_version'),
    schema='partner'
    )
    op.create_index('idx_prompt_bindings_active', 'prompt_bindings', ['is_active'], unique=False, schema='partner')
    op.create_index('idx_prompt_bindings_scope', 'prompt_bindings', ['scope_type', 'scope_id'], unique=False, schema='partner')
    op.create_index('idx_prompt_bindings_version', 'prompt_bindings', ['template_version_id'], unique=False, schema='partner')
    op.create_table('session_messages',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('session_id', sa.BigInteger(), nullable=False),
    sa.Column('sender_type', sa.Text(), nullable=False),
    sa.Column('sender_id', sa.BigInteger(), nullable=True),
    sa.Column('message_type', sa.Text(), server_default=sa.text("'text'"), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('tokens', sa.Integer(), nullable=True),
    sa.Column('latency_ms', sa.Integer(), nullable=True),
    sa.Column('meta', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('content_vector', pgvector.sqlalchemy.vector.VECTOR(dim=1536), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("message_type IN ('text','image','audio','file','tool')", name=op.f('ck_session_messages_chk_session_messages_type')),
    sa.CheckConstraint("sender_type IN ('student','staff','system')", name=op.f('ck_session_messages_chk_session_messages_sender')),
    sa.CheckConstraint('latency_ms IS NULL OR latency_ms >= 0', name=op.f('ck_session_messages_chk_session_messages_latency_nonneg')),
    sa.CheckConstraint('tokens IS NULL OR tokens >= 0', name=op.f('ck_session_messages_chk_session_messages_tokens_nonneg')),
    sa.ForeignKeyConstraint(['session_id'], ['partner.ai_sessions.id'], name=op.f('fk_session_messages_session_id_ai_sessions'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_session_messages')),
    schema='partner'
    )
    op.create_index('idx_session_messages_sender', 'session_messages', ['sender_type', 'sender_id'], unique=False, schema='partner')
    op.create_index('idx_session_messages_session_time', 'session_messages', ['session_id', 'created_at'], unique=False, schema='partner')
    op.create_index('idx_session_messages_type_time', 'session_messages', ['message_type', 'created_at'], unique=False, schema='partner')
    op.create_index('idx_session_messages_vec_ivfflat', 'session_messages', ['content_vector'], unique=False, schema='partner', postgresql_using='ivfflat', postgresql_with={'lists': 100}, postgresql_ops={'content_vector': 'vector_cosine_ops'})
    op.create_table('usage_events_llm',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('session_id', sa.BigInteger(), nullable=True),
    sa.Column('class_id', sa.BigInteger(), nullable=True),
    sa.Column('student_id', sa.BigInteger(), nullable=True),
    sa.Column('provider', sa.Text(), nullable=False),
    sa.Column('model_name', sa.Text(), nullable=False),
    sa.Column('tokens_prompt', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('tokens_completion', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('total_cost', sa.Numeric(precision=14, scale=4), server_default=sa.text('0'), nullable=False),
    sa.Column('success', sa.Boolean(), server_default=sa.text('true'), nullable=False),
    sa.Column('recorded_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('tokens_prompt >= 0 AND tokens_completion >= 0 AND total_cost >= 0', name=op.f('ck_usage_events_llm_chk_usage_events_llm_nonneg')),
    sa.ForeignKeyConstraint(['class_id'], ['partner.classes.id'], name=op.f('fk_usage_events_llm_class_id_classes'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['session_id'], ['partner.ai_sessions.id'], name=op.f('fk_usage_events_llm_session_id_ai_sessions'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['student_id'], ['partner.students.id'], name=op.f('fk_usage_events_llm_student_id_students'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_usage_events_llm')),
    schema='partner'
    )
    op.create_index('idx_usage_events_llm_class_time', 'usage_events_llm', ['class_id', 'recorded_at'], unique=False, schema='partner')
    op.create_index('idx_usage_events_llm_provider_model_time', 'usage_events_llm', ['provider', 'model_name', 'recorded_at'], unique=False, schema='partner')
    op.create_index('idx_usage_events_llm_session_time', 'usage_events_llm', ['session_id', 'recorded_at'], unique=False, schema='partner')
    op.create_index('idx_usage_events_llm_student_time', 'usage_events_llm', ['student_id', 'recorded_at'], unique=False, schema='partner')
    op.create_index('idx_usage_events_llm_success_time', 'usage_events_llm', ['success', 'recorded_at'], unique=False, schema='partner')
    op.create_table('usage_events_stt',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('session_id', sa.BigInteger(), nullable=True),
    sa.Column('class_id', sa.BigInteger(), nullable=True),
    sa.Column('student_id', sa.BigInteger(), nullable=True),
    sa.Column('provider', sa.Text(), nullable=False),
    sa.Column('media_duration_seconds', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('total_cost', sa.Numeric(precision=14, scale=4), server_default=sa.text('0'), nullable=False),
    sa.Column('recorded_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('media_duration_seconds >= 0 AND total_cost >= 0', name=op.f('ck_usage_events_stt_chk_usage_events_stt_nonneg')),
    sa.ForeignKeyConstraint(['class_id'], ['partner.classes.id'], name=op.f('fk_usage_events_stt_class_id_classes'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['session_id'], ['partner.ai_sessions.id'], name=op.f('fk_usage_events_stt_session_id_ai_sessions'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['student_id'], ['partner.students.id'], name=op.f('fk_usage_events_stt_student_id_students'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_usage_events_stt')),
    schema='partner'
    )
    op.create_index('idx_usage_events_stt_class_time', 'usage_events_stt', ['class_id', 'recorded_at'], unique=False, schema='partner')
    op.create_index('idx_usage_events_stt_provider_time', 'usage_events_stt', ['provider', 'recorded_at'], unique=False, schema='partner')
    op.create_index('idx_usage_events_stt_session_time', 'usage_events_stt', ['session_id', 'recorded_at'], unique=False, schema='partner')
    op.create_index('idx_usage_events_stt_student_time', 'usage_events_stt', ['student_id', 'recorded_at'], unique=False, schema='partner')
    op.create_table('enrollment_finance_monthly',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('enrollment_id', sa.BigInteger(), nullable=False),
    sa.Column('month', sa.Date(), nullable=False),
    sa.Column('contract_amount', sa.Numeric(precision=14, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('api_cost', sa.Numeric(precision=14, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('platform_fee', sa.Numeric(precision=14, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('payout_amount', sa.Numeric(precision=14, scale=2), server_default=sa.text('0'), nullable=False),
    sa.CheckConstraint("date_trunc('month', month::timestamp) = month::timestamp", name=op.f('ck_enrollment_finance_monthly_chk_efm_month_is_first_day')),
    sa.CheckConstraint('contract_amount >= 0 AND api_cost >= 0 AND platform_fee >= 0 AND payout_amount >= 0', name=op.f('ck_enrollment_finance_monthly_chk_efm_amounts_nonneg')),
    sa.ForeignKeyConstraint(['enrollment_id'], ['partner.enrollments.id'], name=op.f('fk_enrollment_finance_monthly_enrollment_id_enrollments'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_enrollment_finance_monthly_partner_id_partners'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_enrollment_finance_monthly')),
    sa.UniqueConstraint('enrollment_id', 'month', name='uq_efm_enrollment_month'),
    schema='partner'
    )
    op.create_index('idx_efm_enrollment_month', 'enrollment_finance_monthly', ['enrollment_id', 'month'], unique=False, schema='partner')
    op.create_index('idx_efm_partner_month', 'enrollment_finance_monthly', ['partner_id', 'month'], unique=False, schema='partner')
    op.create_table('invoice_items',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('invoice_id', sa.BigInteger(), nullable=False),
    sa.Column('enrollment_id', sa.BigInteger(), nullable=True),
    sa.Column('student_id', sa.BigInteger(), nullable=True),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('quantity', sa.Integer(), server_default=sa.text('1'), nullable=False),
    sa.Column('unit_price', sa.Numeric(precision=14, scale=2), server_default=sa.text('0'), nullable=False),
    sa.Column('amount', sa.Numeric(precision=14, scale=2), nullable=False),
    sa.Column('sort_order', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.CheckConstraint('(enrollment_id IS NOT NULL) OR (student_id IS NOT NULL)', name=op.f('ck_invoice_items_chk_invoice_items_target_present')),
    sa.CheckConstraint('amount = quantity * unit_price', name=op.f('ck_invoice_items_chk_invoice_items_amount_eq')),
    sa.CheckConstraint('amount >= 0', name=op.f('ck_invoice_items_chk_invoice_items_amount_nonneg')),
    sa.CheckConstraint('quantity >= 1', name=op.f('ck_invoice_items_chk_invoice_items_qty_pos')),
    sa.CheckConstraint('sort_order >= 0', name=op.f('ck_invoice_items_chk_invoice_items_sort_nonneg')),
    sa.CheckConstraint('unit_price >= 0', name=op.f('ck_invoice_items_chk_invoice_items_unit_price_nonneg')),
    sa.ForeignKeyConstraint(['enrollment_id'], ['partner.enrollments.id'], name=op.f('fk_invoice_items_enrollment_id_enrollments'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['invoice_id'], ['partner.invoices.id'], name=op.f('fk_invoice_items_invoice_id_invoices'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['student_id'], ['partner.students.id'], name=op.f('fk_invoice_items_student_id_students'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_invoice_items')),
    schema='partner'
    )
    op.create_index('idx_invoice_items_enrollment', 'invoice_items', ['enrollment_id'], unique=False, schema='partner')
    op.create_index('idx_invoice_items_invoice_sort', 'invoice_items', ['invoice_id', 'sort_order'], unique=False, schema='partner')
    op.create_index('idx_invoice_items_student', 'invoice_items', ['student_id'], unique=False, schema='partner')
    op.create_table('usage_daily',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('partner_id', sa.BigInteger(), nullable=False),
    sa.Column('class_id', sa.BigInteger(), nullable=True),
    sa.Column('enrollment_id', sa.BigInteger(), nullable=True),
    sa.Column('student_id', sa.BigInteger(), nullable=True),
    sa.Column('usage_date', sa.Date(), nullable=False),
    sa.Column('provider', sa.Text(), nullable=False),
    sa.Column('total_sessions', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('total_messages', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('total_tokens', sa.Integer(), server_default=sa.text('0'), nullable=False),
    sa.Column('total_cost', sa.Numeric(precision=14, scale=4), server_default=sa.text('0'), nullable=False),
    sa.CheckConstraint('(enrollment_id IS NOT NULL) OR (class_id IS NOT NULL) OR (student_id IS NOT NULL)', name=op.f('ck_usage_daily_chk_usage_daily_any_dim')),
    sa.CheckConstraint('total_sessions >= 0 AND total_messages >= 0 AND total_tokens >= 0 AND total_cost >= 0', name=op.f('ck_usage_daily_chk_usage_daily_nonneg')),
    sa.ForeignKeyConstraint(['class_id'], ['partner.classes.id'], name=op.f('fk_usage_daily_class_id_classes'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['enrollment_id'], ['partner.enrollments.id'], name=op.f('fk_usage_daily_enrollment_id_enrollments'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['partner_id'], ['partner.partners.id'], name=op.f('fk_usage_daily_partner_id_partners'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['student_id'], ['partner.students.id'], name=op.f('fk_usage_daily_student_id_students'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_usage_daily')),
    schema='partner'
    )
    op.create_index('idx_usage_daily_class_date', 'usage_daily', ['class_id', 'usage_date'], unique=False, schema='partner')
    op.create_index('idx_usage_daily_enrollment_date', 'usage_daily', ['enrollment_id', 'usage_date'], unique=False, schema='partner')
    op.create_index('idx_usage_daily_student_date', 'usage_daily', ['student_id', 'usage_date'], unique=False, schema='partner')
    op.create_index('uq_usage_daily_class', 'usage_daily', ['partner_id', 'class_id', 'usage_date', 'provider'], unique=True, schema='partner', postgresql_where=sa.text('enrollment_id IS NULL AND class_id IS NOT NULL'))
    op.create_index('uq_usage_daily_enrollment', 'usage_daily', ['enrollment_id', 'usage_date', 'provider'], unique=True, schema='partner', postgresql_where=sa.text('enrollment_id IS NOT NULL'))
    op.create_index('uq_usage_daily_student', 'usage_daily', ['partner_id', 'student_id', 'usage_date', 'provider'], unique=True, schema='partner', postgresql_where=sa.text('enrollment_id IS NULL AND class_id IS NULL AND student_id IS NOT NULL'))
    op.create_foreign_key(op.f('fk_org_user_link_organization_id_organizations'), 'org_user_link', 'organizations', ['organization_id'], ['organization_id'], source_schema='links', referent_schema='supervisor', ondelete='CASCADE')
    op.create_foreign_key(op.f('fk_org_user_link_user_id_users'), 'org_user_link', 'users', ['user_id'], ['user_id'], source_schema='links', referent_schema='user', ondelete='CASCADE')
    op.create_foreign_key(op.f('fk_partner_org_link_partner_id_partners'), 'partner_org_link', 'partners', ['partner_id'], ['id'], source_schema='links', referent_schema='partner', ondelete='CASCADE')
    op.create_foreign_key(op.f('fk_partner_org_link_organization_id_organizations'), 'partner_org_link', 'organizations', ['organization_id'], ['organization_id'], source_schema='links', referent_schema='supervisor', ondelete='CASCADE')
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(op.f('fk_partner_org_link_organization_id_organizations'), 'partner_org_link', schema='links', type_='foreignkey')
    op.drop_constraint(op.f('fk_partner_org_link_partner_id_partners'), 'partner_org_link', schema='links', type_='foreignkey')
    op.drop_constraint(op.f('fk_org_user_link_user_id_users'), 'org_user_link', schema='links', type_='foreignkey')
    op.drop_constraint(op.f('fk_org_user_link_organization_id_organizations'), 'org_user_link', schema='links', type_='foreignkey')
    op.drop_index('uq_usage_daily_student', table_name='usage_daily', schema='partner', postgresql_where=sa.text('enrollment_id IS NULL AND class_id IS NULL AND student_id IS NOT NULL'))
    op.drop_index('uq_usage_daily_enrollment', table_name='usage_daily', schema='partner', postgresql_where=sa.text('enrollment_id IS NOT NULL'))
    op.drop_index('uq_usage_daily_class', table_name='usage_daily', schema='partner', postgresql_where=sa.text('enrollment_id IS NULL AND class_id IS NOT NULL'))
    op.drop_index('idx_usage_daily_student_date', table_name='usage_daily', schema='partner')
    op.drop_index('idx_usage_daily_enrollment_date', table_name='usage_daily', schema='partner')
    op.drop_index('idx_usage_daily_class_date', table_name='usage_daily', schema='partner')
    op.drop_table('usage_daily', schema='partner')
    op.drop_index('idx_invoice_items_student', table_name='invoice_items', schema='partner')
    op.drop_index('idx_invoice_items_invoice_sort', table_name='invoice_items', schema='partner')
    op.drop_index('idx_invoice_items_enrollment', table_name='invoice_items', schema='partner')
    op.drop_table('invoice_items', schema='partner')
    op.drop_index('idx_efm_partner_month', table_name='enrollment_finance_monthly', schema='partner')
    op.drop_index('idx_efm_enrollment_month', table_name='enrollment_finance_monthly', schema='partner')
    op.drop_table('enrollment_finance_monthly', schema='partner')
    op.drop_index('idx_usage_events_stt_student_time', table_name='usage_events_stt', schema='partner')
    op.drop_index('idx_usage_events_stt_session_time', table_name='usage_events_stt', schema='partner')
    op.drop_index('idx_usage_events_stt_provider_time', table_name='usage_events_stt', schema='partner')
    op.drop_index('idx_usage_events_stt_class_time', table_name='usage_events_stt', schema='partner')
    op.drop_table('usage_events_stt', schema='partner')
    op.drop_index('idx_usage_events_llm_success_time', table_name='usage_events_llm', schema='partner')
    op.drop_index('idx_usage_events_llm_student_time', table_name='usage_events_llm', schema='partner')
    op.drop_index('idx_usage_events_llm_session_time', table_name='usage_events_llm', schema='partner')
    op.drop_index('idx_usage_events_llm_provider_model_time', table_name='usage_events_llm', schema='partner')
    op.drop_index('idx_usage_events_llm_class_time', table_name='usage_events_llm', schema='partner')
    op.drop_table('usage_events_llm', schema='partner')
    op.drop_index('idx_session_messages_vec_ivfflat', table_name='session_messages', schema='partner', postgresql_using='ivfflat', postgresql_with={'lists': 100}, postgresql_ops={'content_vector': 'vector_cosine_ops'})
    op.drop_index('idx_session_messages_type_time', table_name='session_messages', schema='partner')
    op.drop_index('idx_session_messages_session_time', table_name='session_messages', schema='partner')
    op.drop_index('idx_session_messages_sender', table_name='session_messages', schema='partner')
    op.drop_table('session_messages', schema='partner')
    op.drop_index('idx_prompt_bindings_version', table_name='prompt_bindings', schema='partner')
    op.drop_index('idx_prompt_bindings_scope', table_name='prompt_bindings', schema='partner')
    op.drop_index('idx_prompt_bindings_active', table_name='prompt_bindings', schema='partner')
    op.drop_table('prompt_bindings', schema='partner')
    op.drop_index('idx_enrollments_student', table_name='enrollments', schema='partner')
    op.drop_index('idx_enrollments_status_time', table_name='enrollments', schema='partner')
    op.drop_index('idx_enrollments_class', table_name='enrollments', schema='partner')
    op.drop_table('enrollments', schema='partner')
    op.drop_index('idx_comparison_run_items_status', table_name='comparison_run_items', schema='partner')
    op.drop_index('idx_comparison_run_items_run', table_name='comparison_run_items', schema='partner')
    op.drop_index('idx_comparison_run_items_prompt_ver', table_name='comparison_run_items', schema='partner')
    op.drop_table('comparison_run_items', schema='partner')
    op.drop_index('idx_prompt_template_versions_template', table_name='prompt_template_versions', schema='partner')
    op.drop_table('prompt_template_versions', schema='partner')
    op.drop_index('idx_invite_codes_partner_status', table_name='invite_codes', schema='partner')
    op.drop_table('invite_codes', schema='partner')
    op.drop_index('idx_class_instructors_partner_user', table_name='class_instructors', schema='partner')
    op.drop_index('idx_class_instructors_class', table_name='class_instructors', schema='partner')
    op.drop_table('class_instructors', schema='partner')
    op.drop_index('idx_class_finance_class_month', table_name='class_finance_monthly', schema='partner')
    op.drop_table('class_finance_monthly', schema='partner')
    op.drop_index('idx_ai_sessions_student', table_name='ai_sessions', schema='partner')
    op.drop_index('idx_ai_sessions_status', table_name='ai_sessions', schema='partner')
    op.drop_index('idx_ai_sessions_started', table_name='ai_sessions', schema='partner')
    op.drop_index('idx_ai_sessions_mode', table_name='ai_sessions', schema='partner')
    op.drop_index('idx_ai_sessions_class', table_name='ai_sessions', schema='partner')
    op.drop_table('ai_sessions', schema='partner')
    op.drop_index('idx_report_runs_status_time', table_name='report_runs', schema='supervisor')
    op.drop_index('idx_report_runs_schedule', table_name='report_runs', schema='supervisor')
    op.drop_index('idx_report_runs_report_time', table_name='report_runs', schema='supervisor')
    op.drop_table('report_runs', schema='supervisor')
    op.drop_index('idx_prompt_templates_partner_name', table_name='prompt_templates', schema='partner')
    op.drop_index('idx_prompt_templates_is_archived', table_name='prompt_templates', schema='partner')
    op.drop_table('prompt_templates', schema='partner')
    op.drop_index('idx_payout_items_payout', table_name='payout_items', schema='partner')
    op.drop_index('idx_payout_items_invoice', table_name='payout_items', schema='partner')
    op.drop_table('payout_items', schema='partner')
    op.drop_index('idx_org_llm_settings_partner', table_name='org_llm_settings', schema='partner')
    op.drop_index('idx_org_llm_settings_cred', table_name='org_llm_settings', schema='partner')
    op.drop_table('org_llm_settings', schema='partner')
    op.drop_index('idx_notification_preferences_user', table_name='notification_preferences', schema='partner')
    op.drop_table('notification_preferences', schema='partner')
    op.drop_table('mfa_settings', schema='partner')
    op.drop_index('idx_login_activity_user_time', table_name='login_activity', schema='partner')
    op.drop_table('login_activity', schema='partner')
    op.drop_index('idx_email_subscriptions_user', table_name='email_subscriptions', schema='partner')
    op.drop_index('idx_email_subscriptions_type', table_name='email_subscriptions', schema='partner')
    op.drop_table('email_subscriptions', schema='partner')
    op.drop_index('idx_comparison_runs_student', table_name='comparison_runs', schema='partner')
    op.drop_index('idx_comparison_runs_status_time', table_name='comparison_runs', schema='partner')
    op.drop_index('idx_comparison_runs_initiated_by', table_name='comparison_runs', schema='partner')
    op.drop_table('comparison_runs', schema='partner')
    op.drop_index('idx_classes_course_status', table_name='classes', schema='partner')
    op.drop_table('classes', schema='partner')
    op.drop_index('idx_practice_ratings_user', table_name='practice_ratings', schema='user')
    op.drop_index('idx_practice_ratings_response', table_name='practice_ratings', schema='user')
    op.drop_table('practice_ratings', schema='user')
    op.drop_index('idx_scheduled_reports_status_next', table_name='scheduled_reports', schema='supervisor')
    op.drop_index('idx_scheduled_reports_report', table_name='scheduled_reports', schema='supervisor')
    op.drop_table('scheduled_reports', schema='supervisor')
    op.drop_index('uq_students_partner_email_notnull', table_name='students', schema='partner', postgresql_where=sa.text('email IS NOT NULL'))
    op.drop_index('idx_students_partner_status', table_name='students', schema='partner')
    op.drop_index('idx_students_partner_email', table_name='students', schema='partner')
    op.drop_table('students', schema='partner')
    op.drop_index('idx_provider_credentials_validated', table_name='provider_credentials', schema='partner')
    op.drop_index('idx_provider_credentials_partner_provider', table_name='provider_credentials', schema='partner')
    op.drop_index('idx_provider_credentials_active', table_name='provider_credentials', schema='partner')
    op.drop_table('provider_credentials', schema='partner')
    op.drop_index('idx_payouts_status', table_name='payouts', schema='partner')
    op.drop_index('idx_payouts_partner_period', table_name='payouts', schema='partner')
    op.drop_table('payouts', schema='partner')
    op.drop_index('uq_payout_accounts_partner_primary', table_name='payout_accounts', schema='partner', postgresql_where=sa.text('is_primary = true'))
    op.drop_index('idx_payout_accounts_partner', table_name='payout_accounts', schema='partner')
    op.drop_table('payout_accounts', schema='partner')
    op.drop_index('idx_partner_users_role', table_name='partner_users', schema='partner')
    op.drop_index('idx_partner_users_partner_email', table_name='partner_users', schema='partner')
    op.drop_index('idx_partner_users_last_login', table_name='partner_users', schema='partner')
    op.drop_index('idx_partner_users_active', table_name='partner_users', schema='partner')
    op.drop_table('partner_users', schema='partner')
    op.drop_index('idx_model_usage_monthly_provider_model', table_name='model_usage_monthly', schema='partner')
    op.drop_index('idx_model_usage_monthly_partner_month', table_name='model_usage_monthly', schema='partner')
    op.drop_table('model_usage_monthly', schema='partner')
    op.drop_index('idx_invoices_status', table_name='invoices', schema='partner')
    op.drop_index('idx_invoices_partner_period', table_name='invoices', schema='partner')
    op.drop_table('invoices', schema='partner')
    op.drop_index('idx_fee_rates_partner_type', table_name='fee_rates', schema='partner')
    op.drop_table('fee_rates', schema='partner')
    op.drop_index('idx_courses_partner_status', table_name='courses', schema='partner')
    op.drop_table('courses', schema='partner')
    op.drop_index('idx_business_profiles_country', table_name='business_profiles', schema='partner')
    op.drop_table('business_profiles', schema='partner')
    op.drop_index('idx_api_cost_daily_provider_date', table_name='api_cost_daily', schema='partner')
    op.drop_index('idx_api_cost_daily_partner_date', table_name='api_cost_daily', schema='partner')
    op.drop_table('api_cost_daily', schema='partner')
    op.drop_index('idx_analytics_snapshots_type_date', table_name='analytics_snapshots', schema='partner')
    op.drop_index('idx_analytics_snapshots_partner_date', table_name='analytics_snapshots', schema='partner')
    op.drop_table('analytics_snapshots', schema='partner')
    op.drop_index('idx_practice_responses_model_time', table_name='practice_responses', schema='user')
    op.drop_table('practice_responses', schema='user')
    op.drop_index('idx_document_chunks_vec_ivfflat', table_name='document_chunks', schema='user', postgresql_using='ivfflat', postgresql_with={'lists': 100}, postgresql_ops={'vector_memory': 'vector_cosine_ops'})
    op.drop_index('idx_document_chunks_doc_page', table_name='document_chunks', schema='user')
    op.drop_index('idx_document_chunks_doc_index', table_name='document_chunks', schema='user')
    op.drop_table('document_chunks', schema='user')
    op.drop_index('idx_agent_usage_stats_last_used', table_name='agent_usage_stats', schema='user')
    op.drop_table('agent_usage_stats', schema='user')
    op.drop_index('uq_agent_prompts_active_once', table_name='agent_prompts', schema='user', postgresql_where=sa.text('is_active = true'))
    op.drop_index('idx_agent_prompts_agent', table_name='agent_prompts', schema='user')
    op.drop_table('agent_prompts', schema='user')
    op.drop_index('idx_agent_examples_agent_pos', table_name='agent_examples', schema='user')
    op.drop_table('agent_examples', schema='user')
    op.drop_index('ix_user_role_assignments_user', table_name='user_role_assignments', schema='supervisor')
    op.drop_index('ix_user_role_assignments_role', table_name='user_role_assignments', schema='supervisor')
    op.drop_table('user_role_assignments', schema='supervisor')
    op.drop_index('idx_user_acquisition_user_time', table_name='user_acquisition', schema='supervisor')
    op.drop_index('idx_user_acquisition_channel_time', table_name='user_acquisition', schema='supervisor')
    op.drop_table('user_acquisition', schema='supervisor')
    op.drop_index('ix_sessions_user_started', table_name='sessions', schema='supervisor')
    op.drop_index('ix_sessions_org_started', table_name='sessions', schema='supervisor')
    op.drop_table('sessions', schema='supervisor')
    op.drop_index('idx_reports_type', table_name='reports', schema='supervisor')
    op.drop_index('idx_reports_name', table_name='reports', schema='supervisor')
    op.drop_table('reports', schema='supervisor')
    op.drop_index('uq_rate_limits_plan', table_name='rate_limits', schema='supervisor', postgresql_where=sa.text('plan_id IS NOT NULL AND organization_id IS NULL'))
    op.drop_index('uq_rate_limits_org', table_name='rate_limits', schema='supervisor', postgresql_where=sa.text('organization_id IS NOT NULL'))
    op.drop_index('idx_rate_limits_type', table_name='rate_limits', schema='supervisor')
    op.drop_table('rate_limits', schema='supervisor')
    op.drop_index('idx_platform_settings_key', table_name='platform_settings', schema='supervisor')
    op.drop_index('idx_platform_settings_category', table_name='platform_settings', schema='supervisor')
    op.drop_table('platform_settings', schema='supervisor')
    op.drop_index('idx_feedback_user_time', table_name='feedback', schema='supervisor')
    op.drop_index('idx_feedback_rating_time', table_name='feedback', schema='supervisor')
    op.drop_index('idx_feedback_org_time', table_name='feedback', schema='supervisor')
    op.drop_table('feedback', schema='supervisor')
    op.drop_table('api_usage', schema='supervisor')
    op.drop_index('idx_api_keys_status', table_name='api_keys', schema='supervisor')
    op.drop_index('idx_api_keys_last_used', table_name='api_keys', schema='supervisor')
    op.drop_table('api_keys', schema='supervisor')
    op.drop_index('idx_partners_status', table_name='partners', schema='partner')
    op.drop_index('idx_partners_created_by', table_name='partners', schema='partner')
    op.drop_index('idx_partners_created', table_name='partners', schema='partner')
    op.drop_table('partners', schema='partner')
    op.drop_index('idx_project_tag_assignments_project', table_name='project_tag_assignments', schema='user')
    op.drop_table('project_tag_assignments', schema='user')
    op.drop_index('idx_project_metrics_type_time', table_name='project_metrics', schema='user')
    op.drop_index('idx_project_metrics_project_time', table_name='project_metrics', schema='user')
    op.drop_table('project_metrics', schema='user')
    op.drop_index('idx_project_members_user', table_name='project_members', schema='user')
    op.drop_index('idx_project_members_project', table_name='project_members', schema='user')
    op.drop_table('project_members', schema='user')
    op.drop_index('idx_project_activity_type_time', table_name='project_activity', schema='user')
    op.drop_index('idx_project_activity_project_time', table_name='project_activity', schema='user')
    op.drop_table('project_activity', schema='user')
    op.drop_index('uq_practice_session_models_primary_once', table_name='practice_session_models', schema='user', postgresql_where=sa.text('is_primary = true'))
    op.drop_index('idx_practice_session_models_session', table_name='practice_session_models', schema='user')
    op.drop_table('practice_session_models', schema='user')
    op.drop_index('idx_model_comparisons_session_time', table_name='model_comparisons', schema='user')
    op.drop_table('model_comparisons', schema='user')
    op.drop_index('idx_document_usage_user_time', table_name='document_usage', schema='user')
    op.drop_index('idx_document_usage_doc_time', table_name='document_usage', schema='user')
    op.drop_table('document_usage', schema='user')
    op.drop_index('idx_document_tag_assignments_tag', table_name='document_tag_assignments', schema='user')
    op.drop_index('idx_document_tag_assignments_doc', table_name='document_tag_assignments', schema='user')
    op.drop_table('document_tag_assignments', schema='user')
    op.drop_index('idx_document_jobs_status', table_name='document_processing_jobs', schema='user')
    op.drop_index('idx_document_jobs_doc_time', table_name='document_processing_jobs', schema='user')
    op.drop_table('document_processing_jobs', schema='user')
    op.drop_index('idx_document_pages_doc_page', table_name='document_pages', schema='user')
    op.drop_table('document_pages', schema='user')
    op.drop_index('idx_ai_agents_project', table_name='ai_agents', schema='user')
    op.drop_index('idx_ai_agents_owner_status', table_name='ai_agents', schema='user')
    op.drop_index('idx_ai_agents_document', table_name='ai_agents', schema='user')
    op.drop_table('ai_agents', schema='user')
    op.drop_index('idx_webhooks_status', table_name='webhooks', schema='supervisor')
    op.drop_index('idx_webhooks_org', table_name='webhooks', schema='supervisor')
    op.drop_index('idx_webhooks_event', table_name='webhooks', schema='supervisor')
    op.drop_table('webhooks', schema='supervisor')
    op.drop_index('idx_usage_features_org_period', table_name='usage_features', schema='supervisor')
    op.drop_index('idx_usage_features_feature_period', table_name='usage_features', schema='supervisor')
    op.drop_table('usage_features', schema='supervisor')
    op.drop_index('idx_transactions_status_time', table_name='transactions', schema='supervisor')
    op.drop_index('idx_transactions_org_time', table_name='transactions', schema='supervisor')
    op.drop_table('transactions', schema='supervisor')
    op.drop_index('ix_supervisors_status', table_name='supervisors', schema='supervisor')
    op.drop_index('ix_supervisors_signup_at', table_name='supervisors', schema='supervisor')
    op.drop_index('ix_supervisors_org_id', table_name='supervisors', schema='supervisor')
    op.drop_table('supervisors', schema='supervisor')
    op.drop_index('idx_subscription_changes_org_time', table_name='subscription_changes', schema='supervisor')
    op.drop_table('subscription_changes', schema='supervisor')
    op.drop_index('idx_metrics_snapshot_type_date', table_name='metrics_snapshot', schema='supervisor')
    op.drop_index('idx_metrics_snapshot_org_date', table_name='metrics_snapshot', schema='supervisor')
    op.drop_index('idx_metrics_snapshot_date', table_name='metrics_snapshot', schema='supervisor')
    op.drop_table('metrics_snapshot', schema='supervisor')
    op.drop_index('idx_invoices_status', table_name='invoices', schema='supervisor')
    op.drop_index('idx_invoices_org_period', table_name='invoices', schema='supervisor')
    op.drop_table('invoices', schema='supervisor')
    op.drop_table('user_security_settings', schema='user')
    op.drop_table('user_profiles', schema='user')
    op.drop_table('user_privacy_settings', schema='user')
    op.drop_table('user_preferences', schema='user')
    op.drop_index('idx_user_preference_history_user_time', table_name='user_preference_history', schema='user')
    op.drop_table('user_preference_history', schema='user')
    op.drop_index('idx_user_notif_pref_user', table_name='user_notification_preferences', schema='user')
    op.drop_index('idx_user_notif_pref_channel_event', table_name='user_notification_preferences', schema='user')
    op.drop_table('user_notification_preferences', schema='user')
    op.drop_index('idx_user_login_sessions_user_time', table_name='user_login_sessions', schema='user')
    op.drop_index('idx_user_login_sessions_current', table_name='user_login_sessions', schema='user')
    op.drop_table('user_login_sessions', schema='user')
    op.drop_index('idx_user_activity_user_time', table_name='user_activity_events', schema='user')
    op.drop_index('idx_user_activity_type_time', table_name='user_activity_events', schema='user')
    op.drop_index('idx_user_activity_related', table_name='user_activity_events', schema='user')
    op.drop_table('user_activity_events', schema='user')
    op.drop_index('idx_user_achievements_user_time', table_name='user_achievements', schema='user')
    op.drop_table('user_achievements', schema='user')
    op.drop_index('idx_usage_summaries_user_period', table_name='usage_summaries', schema='user')
    op.drop_table('usage_summaries', schema='user')
    op.drop_index('idx_projects_owner_status', table_name='projects', schema='user')
    op.drop_index('idx_projects_last_activity', table_name='projects', schema='user')
    op.drop_table('projects', schema='user')
    op.drop_index('idx_practice_sessions_user_time', table_name='practice_sessions', schema='user')
    op.drop_table('practice_sessions', schema='user')
    op.drop_index('idx_notification_events_user_time', table_name='notification_events', schema='user')
    op.drop_index('idx_notification_events_status_time', table_name='notification_events', schema='user')
    op.drop_index('idx_notification_events_channel_event_time', table_name='notification_events', schema='user')
    op.drop_table('notification_events', schema='user')
    op.drop_index('idx_model_usage_stats_user', table_name='model_usage_stats', schema='user')
    op.drop_index('idx_model_usage_stats_model', table_name='model_usage_stats', schema='user')
    op.drop_index('idx_model_usage_stats_last_used', table_name='model_usage_stats', schema='user')
    op.drop_table('model_usage_stats', schema='user')
    op.drop_index('idx_documents_status_time', table_name='documents', schema='user')
    op.drop_index('idx_documents_owner_time', table_name='documents', schema='user')
    op.drop_index('idx_documents_name_trgm', table_name='documents', schema='user', postgresql_using='gin', postgresql_ops={'name': 'gin_trgm_ops'})
    op.drop_table('documents', schema='user')
    op.drop_index('idx_account_deletion_requests_user', table_name='account_deletion_requests', schema='user')
    op.drop_index('idx_account_deletion_requests_status_time', table_name='account_deletion_requests', schema='user')
    op.drop_table('account_deletion_requests', schema='user')
    op.drop_index('ix_organizations_status', table_name='organizations', schema='supervisor')
    op.drop_index('ix_organizations_plan_id', table_name='organizations', schema='supervisor')
    op.drop_index('ix_organizations_joined_at', table_name='organizations', schema='supervisor')
    op.drop_table('organizations', schema='supervisor')
    op.drop_index('idx_arpu_history_plan_period', table_name='arpu_history', schema='supervisor')
    op.drop_index('idx_arpu_history_period', table_name='arpu_history', schema='supervisor')
    op.drop_table('arpu_history', schema='supervisor')
    op.drop_index('idx_users_status_created', table_name='users', schema='user')
    op.drop_table('users', schema='user')
    op.drop_index('idx_project_tags_name', table_name='project_tags', schema='user')
    op.drop_table('project_tags', schema='user')
    op.drop_index('idx_document_tags_name', table_name='document_tags', schema='user')
    op.drop_table('document_tags', schema='user')
    op.drop_table('user_roles', schema='supervisor')
    op.drop_table('system_metrics', schema='supervisor')
    op.drop_index('idx_service_status_status_time', table_name='service_status', schema='supervisor')
    op.drop_index('idx_service_status_service_time', table_name='service_status', schema='supervisor')
    op.drop_table('service_status', schema='supervisor')
    op.drop_table('plans', schema='supervisor')
    op.drop_table('logs', schema='supervisor')
    op.drop_index('idx_llm_providers_status', table_name='llm_providers', schema='supervisor')
    op.drop_index('idx_llm_providers_name', table_name='llm_providers', schema='supervisor')
    op.drop_table('llm_providers', schema='supervisor')
    op.drop_index('idx_integrations_type', table_name='integrations', schema='supervisor')
    op.drop_index('idx_integrations_status', table_name='integrations', schema='supervisor')
    op.drop_table('integrations', schema='supervisor')
    op.drop_index('idx_growth_channels_name', table_name='growth_channels', schema='supervisor')
    op.drop_table('growth_channels', schema='supervisor')
    op.drop_index('idx_forecasts_metric_period', table_name='forecasts', schema='supervisor')
    op.drop_table('forecasts', schema='supervisor')
    op.drop_index('idx_feature_toggles_name', table_name='feature_toggles', schema='supervisor')
    op.drop_index('idx_feature_toggles_enabled', table_name='feature_toggles', schema='supervisor')
    op.drop_table('feature_toggles', schema='supervisor')
    op.drop_table('events', schema='supervisor')
    op.drop_index('idx_env_variables_scope', table_name='env_variables', schema='supervisor')
    op.drop_table('env_variables', schema='supervisor')
    op.drop_index('idx_email_settings_host_port', table_name='email_settings', schema='supervisor')
    op.drop_table('email_settings', schema='supervisor')
    op.drop_index('idx_danger_zone_logs_type_time', table_name='danger_zone_logs', schema='supervisor')
    op.drop_table('danger_zone_logs', schema='supervisor')
    op.drop_index('idx_cohort_metrics_type_offset', table_name='cohort_metrics', schema='supervisor')
    op.drop_index('idx_cohort_metrics_month', table_name='cohort_metrics', schema='supervisor')
    op.drop_table('cohort_metrics', schema='supervisor')
    op.drop_index('idx_alerts_unresolved', table_name='alerts', schema='supervisor', postgresql_where=sa.text("status <> 'resolved'"))
    op.drop_index('idx_alerts_status_time', table_name='alerts', schema='supervisor')
    op.drop_index('idx_alerts_severity_time', table_name='alerts', schema='supervisor')
    op.drop_index('idx_alerts_category_time', table_name='alerts', schema='supervisor')
    op.drop_table('alerts', schema='supervisor')
    op.drop_index('idx_ai_insights_category_time', table_name='ai_insights', schema='supervisor')
    op.drop_table('ai_insights', schema='supervisor')
    op.drop_index('idx_model_catalog_provider_modality', table_name='model_catalog', schema='partner')
    op.drop_index('idx_model_catalog_active', table_name='model_catalog', schema='partner')
    op.drop_table('model_catalog', schema='partner')
    # ### end Alembic commands ###
